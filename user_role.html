<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .toast {
            transition: all 0.3s ease;
        }
        .toast.hide {
            opacity: 0;
            transform: translateY(20px);
        }
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                display: block;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="spinner inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-2"></div>
                <p class="text-gray-700">Loading...</p>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast fixed bottom-4 right-4 hidden">
            <div class="bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center">
                <span id="toast-message"></span>
                <button onclick="hideToast()" class="ml-4 text-gray-300 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Access Denied State -->
        <div id="access-denied" class="hidden max-w-4xl mx-auto px-4 py-16">
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="mt-3 text-lg font-medium text-gray-900">Access Denied</h3>
                <div class="mt-2 text-sm text-gray-500">
                    <p>You don't have permission to access this page. Please contact your administrator.</p>
                </div>
                <div class="mt-6">
                    <button onclick="window.location.href='/'" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Go back home
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Required State -->
        <div id="login-required" class="hidden max-w-4xl mx-auto px-4 py-16">
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h3 class="mt-3 text-lg font-medium text-gray-900">Authentication Required</h3>
                <div class="mt-2 text-sm text-gray-500">
                    <p>Please log in to access this page.</p>
                </div>
                <div class="mt-6">
                    <button onclick="window.location.href='/login'" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Log in
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content (Visible only for admins) -->
        <div id="main-content" class="hidden max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
                <p class="mt-2 text-sm text-gray-500">Manage users and their roles</p>
            </div>

            <!-- Controls -->
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="relative w-full sm:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input id="search" type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search users...">
                </div>
                <button id="refresh-btn" onclick="fetchUsers()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh Users
                </button>
            </div>

            <!-- User Table -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="table-responsive">
                    <table id="users-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Role</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden p-8 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No users found</h3>
                    <p class="mt-1 text-sm text-gray-500">There are currently no users in the system.</p>
                    <div class="mt-6">
                        <button onclick="fetchUsers()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Refresh Users
                        </button>
                    </div>
                </div>

                <!-- Loading State for Table -->
                <div id="table-loading" class="p-8 text-center">
                    <div class="spinner inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-2"></div>
                    <p class="text-gray-700">Loading users...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://bbvyjeljeyofswuijlyg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Current User
        let currentUser = null;
        let users = [];

        // DOM Elements
        const loadingElement = document.getElementById('loading');
        const accessDeniedElement = document.getElementById('access-denied');
        const loginRequiredElement = document.getElementById('login-required');
        const mainContentElement = document.getElementById('main-content');
        const usersTableBody = document.getElementById('users-table-body');
        const emptyStateElement = document.getElementById('empty-state');
        const tableLoadingElement = document.getElementById('table-loading');
        const toastElement = document.getElementById('toast');
        const toastMessageElement = document.getElementById('toast-message');
        const searchInput = document.getElementById('search');
        const refreshBtn = document.getElementById('refresh-btn');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
        });

        // Check authentication and permissions
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();

                if (error || !user) {
                    showLoginRequired();
                    return;
                }

                currentUser = user;

                // Check if user has admin role
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', user.id)
                    .single();

                if (roleError || !roleData || roleData.role !== 'admin') {
                    showAccessDenied();
                    return;
                }

                // User is authenticated and has admin role
                showMainContent();
                fetchUsers();
            } catch (err) {
                console.error('Error checking auth:', err);
                showAccessDenied();
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // Show main content
        function showMainContent() {
            mainContentElement.classList.remove('hidden');
        }

        // Show access denied
        function showAccessDenied() {
            accessDeniedElement.classList.remove('hidden');
        }

        // Show login required
        function showLoginRequired() {
            loginRequiredElement.classList.remove('hidden');
        }

        // Fetch users with roles
        async function fetchUsers() {
            try {
                tableLoadingElement.classList.remove('hidden');
                usersTableBody.innerHTML = '';
                emptyStateElement.classList.add('hidden');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5 text-gray-500 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refreshing...
                `;

                // Get profiles from profiles table
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (profilesError) throw profilesError;

                // Get user roles from user_roles table
                const { data: roles, error: rolesError } = await supabase
                    .from('user_roles')
                    .select('user_id, role');

                if (rolesError) throw rolesError;

                // Combine data and set default role as 'user'
                users = profiles.map(profile => {
                    const userRole = roles.find(r => r.user_id === profile.id);
                    return {
                        ...profile,
                        role: userRole ? userRole.role : 'user'
                    };
                });

                renderUsers(users);
            } catch (error) {
                console.error('Error fetching users:', error);
                showToast('Failed to load users. Please try again.', 'error');
            } finally {
                tableLoadingElement.classList.add('hidden');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh Users
                `;
            }
        }

        // Render users to the table
        function renderUsers(usersToRender) {
            if (usersToRender.length === 0) {
                emptyStateElement.classList.remove('hidden');
                return;
            }

            usersTableBody.innerHTML = usersToRender.map(user => {
                const isCurrentUser = currentUser && user.id === currentUser.id;
                const formattedDate = new Date(user.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                                        ${user.full_name ? user.full_name.charAt(0).toUpperCase() : '?'}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.full_name || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${user.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeClass(user.role)}">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formattedDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <select 
                                ${isCurrentUser ? 'disabled' : ''}
                                onchange="updateUserRole('${user.id}', this.value)"
                                class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${isCurrentUser ? 'bg-gray-100 cursor-not-allowed' : ''}"
                            >
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get badge class based on role
        function getRoleBadgeClass(role) {
            switch (role) {
                case 'admin':
                    return 'bg-red-100 text-red-800';
                case 'moderator':
                    return 'bg-blue-100 text-blue-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Update user role
        async function updateUserRole(userId, newRole) {
            try {
                const { error } = await supabase.rpc('assign_user_role', {
                    _user_id: userId,
                    _role: newRole
                });

                if (error) throw error;

                // Update local state
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].role = newRole;
                    renderUsers(users);
                }

                showToast('User role updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating user role:', error);
                showToast('Failed to update user role. Please try again.', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            toastMessageElement.textContent = message;
            
            // Set background color based on type
            const toastContainer = toastElement.querySelector('div');
            toastContainer.className = `bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center`;
            
            if (type === 'error') {
                toastContainer.className = `bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center`;
            } else if (type === 'success') {
                toastContainer.className = `bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center`;
            }
            
            toastElement.classList.remove('hidden');
            setTimeout(hideToast, 5000);
        }

        // Hide toast notification
        function hideToast() {
            toastElement.classList.add('hide');
            setTimeout(() => {
                toastElement.classList.add('hidden');
                toastElement.classList.remove('hide');
            }, 300);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm === '') {
                    renderUsers(users);
                    return;
                }
                
                const filteredUsers = users.filter(user => {
                    return (
                        (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                        (user.role && user.role.toLowerCase().includes(searchTerm))
                    );
                });
                
                renderUsers(filteredUsers);
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Look4Blood User Role Management</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full flex flex-col items-center justify-center p-4">
  <div id="app" class="w-full max-w-4xl"></div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = "https://bbvyjeljeyofswuijlyg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    class UserRoleManager {
      constructor() {
        this.currentUser = null;
        this.currentRoles = [];
        this.users = [];
      }

      async init() {
        await this.checkAuth();
        this.render();
      }

      async checkAuth() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          this.currentUser = null;
          return;
        }
        this.currentUser = session.user;

        // Fetch current user roles
        const { data: roles, error } = await supabaseClient
          .from('user_roles')
          .select('role')
          .eq('user_id', this.currentUser.id);

        if (!error && roles) {
          this.currentRoles = roles.map(r => r.role);
        }
      }

      async fetchUsers() {
        if (!this.currentRoles.includes('admin')) {
          return;
        }

        const { data: profiles, error: profilesError } = await supabaseClient
          .from('profiles')
          .select('id, full_name, email, created_at')
          .order('created_at', { ascending: false });

        if (profilesError) {
          alert('Failed to fetch profiles: ' + profilesError.message);
          return;
        }

        const { data: roles, error: rolesError } = await supabaseClient
          .from('user_roles')
          .select('user_id, role');

        if (rolesError) {
          alert('Failed to fetch roles: ' + rolesError.message);
          return;
        }

        this.users = profiles.map(profile => {
          const userRole = roles.find(r => r.user_id === profile.id);
          return {
            ...profile,
            role: userRole ? userRole.role : 'user'
          };
        });
      }

      async updateRole(userId, newRole) {
        const { error } = await supabaseClient.rpc('assign_user_role', {
          _user_id: userId,
          _role: newRole
        });
        if (error) {
          alert('Failed to update role: ' + error.message);
          return;
        }
        alert('Role updated successfully');
        await this.fetchUsers();
        this.render();
      }

      async signIn() {
        const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'github' });
        if (error) alert('Login failed: ' + error.message);
      }

      async signOut() {
        await supabaseClient.auth.signOut();
        this.currentUser = null;
        this.currentRoles = [];
        this.users = [];
        this.render();
      }

      render() {
        const app = document.getElementById('app');

        if (!this.currentUser) {
          app.innerHTML = `
            <div class="text-center p-6 bg-white rounded shadow">
              <h1 class="text-2xl font-bold mb-4">Welcome to Look4Blood</h1>
              <button class="px-6 py-2 bg-red-600 text-white rounded" id="loginBtn">Login with GitHub</button>
            </div>
          `;
          document.getElementById('loginBtn').onclick = () => this.signIn();
          return;
        }

        const isAdmin = this.currentRoles.includes('admin');

        app.innerHTML = `
          <div class="bg-white p-6 rounded shadow space-y-4">
            <div class="flex justify-between items-center">
              <h1 class="text-xl font-bold">User Role Management</h1>
              <button class="text-sm text-red-600 underline" id="logoutBtn">Logout</button>
            </div>
            <div class="mb-4">
              Logged in as: <strong>${this.currentUser.email}</strong> <br />
              Roles: <strong>${this.currentRoles.join(', ') || 'user'}</strong>
            </div>

            ${isAdmin ? `
              <button id="refreshBtn" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded">Refresh Users</button>
              <table class="w-full border-collapse border border-gray-300">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-3 py-1 text-left">Name</th>
                    <th class="border border-gray-300 px-3 py-1 text-left">Email</th>
                    <th class="border border-gray-300 px-3 py-1 text-left">Role</th>
                    <th class="border border-gray-300 px-3 py-1 text-left">Joined</th>
                    <th class="border border-gray-300 px-3 py-1 text-left">Change Role</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.users.map(user => `
                    <tr class="border border-gray-300">
                      <td class="px-3 py-1">${user.full_name || 'N/A'}</td>
                      <td class="px-3 py-1">${user.email}</td>
                      <td class="px-3 py-1">${user.role}</td>
                      <td class="px-3 py-1">${new Date(user.created_at).toLocaleDateString()}</td>
                      <td class="px-3 py-1">
                        <select data-user-id="${user.id}" class="role-select border rounded px-2 py-1">
                          <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                          <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option>
                          <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : `
              <p class="text-gray-600">You do not have admin privileges.</p>
            `}
          </div>
        `;

        document.getElementById('logoutBtn').onclick = () => this.signOut();

        if (isAdmin) {
          document.getElementById('refreshBtn').onclick = async () => {
            await this.fetchUsers();
            this.render();
          };

          document.querySelectorAll('.role-select').forEach(select => {
            select.addEventListener('change', async (e) => {
              const userId = e.target.dataset.userId;
              const newRole = e.target.value;
              await this.updateRole(userId, newRole);
            });
          });
        }
      }
    }

    const app = new UserRoleManager();
    app.init();
  </script>
</body>
</html>

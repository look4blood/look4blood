<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Look4Blood User Role Management</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full flex flex-col items-center justify-center p-4">
  <div id="app" class="w-full max-w-4xl"></div>
  
  <!-- Modal for creating new role -->
  <div id="roleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Create New Role</h3>
        <div class="mt-2">
          <div class="mb-4">
            <label for="roleName" class="block text-sm font-medium text-gray-700">Role Name</label>
            <input type="text" id="roleName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
          </div>
          <div class="mb-4">
            <label for="roleDescription" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="roleDescription" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div class="mb-4">
            <label for="roleColor" class="block text-sm font-medium text-gray-700">Badge Color</label>
            <select id="roleColor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="yellow">Yellow</option>
              <option value="red">Red</option>
              <option value="purple">Purple</option>
              <option value="indigo">Indigo</option>
              <option value="pink">Pink</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-4">
          <button id="cancelRoleBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
          <button id="saveRoleBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Save Role</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = "https://bbvyjeljeyofswuijlyg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    class UserRoleManager {
      constructor() {
        this.currentUser = null;
        this.currentRoles = [];
        this.users = [];
        this.roles = [];
        this.isLoading = false;
        this.currentPage = 'dashboard'; // Can be 'dashboard', 'users', 'donors', etc.
        
        // Define default roles with their properties
        this.defaultRoles = [
          { name: 'user', description: 'Regular user with basic access', color: 'green' },
          { name: 'moderator', description: 'Content moderator with limited admin privileges', color: 'yellow' },
          { name: 'admin', description: 'System administrator with full access', color: 'red' }
        ];
        
        // Load custom roles from localStorage
        this.loadCustomRoles();
      }
      
      async init() {
        await this.checkAuth();
        await this.loadRoles();
        this.render();
        this.setupModalEventListeners();
      }
      
      loadCustomRoles() {
        const savedRoles = localStorage.getItem('customRoles');
        if (savedRoles) {
          try {
            this.customRoles = JSON.parse(savedRoles);
          } catch (e) {
            this.customRoles = [];
          }
        } else {
          this.customRoles = [];
        }
      }
      
      saveCustomRoles() {
        localStorage.setItem('customRoles', JSON.stringify(this.customRoles));
      }
      
      getAllRoles() {
        return [...this.defaultRoles, ...this.customRoles];
      }
      
      async checkAuth() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          this.currentUser = null;
          this.currentRoles = [];
          return;
        }
        this.currentUser = session.user;
        
        // Fetch user roles from the database
        await this.fetchUserRoles();
      }
      
      async fetchUserRoles() {
        if (!this.currentUser) return;
        
        try {
          // Get roles from user_roles table
          const { data, error } = await supabaseClient
            .from('user_roles')
            .select('role')
            .eq('user_id', this.currentUser.id);
            
          if (error) throw error;
          
          this.currentRoles = data.map(item => item.role);
          
          // Also get role from profiles table as a fallback
          if (this.currentRoles.length === 0) {
            const { data: profileData, error: profileError } = await supabaseClient
              .from('profiles')
              .select('role')
              .eq('id', this.currentUser.id)
              .single();
              
            if (!profileError && profileData && profileData.role) {
              this.currentRoles = [profileData.role];
            }
          }
        } catch (error) {
          console.error('Error fetching user roles:', error);
          this.currentRoles = [];
        }
      }
      
      async loadRoles() {
        try {
          // Get available roles from the enum type
          const { data, error } = await supabaseClient
            .rpc('get_enum_values', { enum_name: 'app_role' });
            
          if (error) {
            console.error('Error loading roles from enum:', error);
            // Fallback to default roles
            this.roles = this.defaultRoles;
          } else {
            // Map enum values to role objects
            this.roles = data.map(roleName => {
              const defaultRole = this.defaultRoles.find(r => r.name === roleName);
              return defaultRole || { 
                name: roleName, 
                description: 'Custom role', 
                color: 'blue' 
              };
            });
          }
        } catch (error) {
          console.error('Error loading roles:', error);
          this.roles = this.defaultRoles;
        }
      }
      
      async fetchUsers() {
        if (!this.currentRoles.includes('admin')) {
          return;
        }
        
        this.isLoading = true;
        this.render();
        
        try {
          // Get all profiles
          const { data: profiles, error: profilesError } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: false });
            
          if (profilesError) throw profilesError;
          
          // Get all user roles
          const { data: userRoles, error: rolesError } = await supabaseClient
            .from('user_roles')
            .select('*');
            
          if (rolesError) throw rolesError;
          
          // Transform the data to match our expected format
          this.users = profiles.map(profile => {
            const userRoleEntries = userRoles.filter(ur => ur.user_id === profile.id);
            const userRolesList = userRoleEntries.map(ur => ur.role);
            
            // Get the primary role (first one or the one from profiles)
            const primaryRole = profile.role || (userRolesList.length > 0 ? userRolesList[0] : 'user');
            
            // Get role properties
            const roleInfo = this.getAllRoles().find(r => r.name === primaryRole) || 
                           { name: primaryRole, description: 'Custom role', color: 'blue' };
            
            return {
              id: profile.id,
              full_name: profile.full_name || '',
              email: profile.email || '',
              created_at: profile.created_at,
              role: primaryRole,
              roleColor: roleInfo.color,
              allRoles: userRolesList
            };
          });
          
        } catch (error) {
          console.error('Error fetching users:', error);
          alert('Failed to fetch users: ' + error.message);
        } finally {
          this.isLoading = false;
          this.render();
        }
      }
      
      async updateRole(userId, newRole) {
        try {
          // Get the current user's roles
          const { data: currentRoles, error: fetchError } = await supabaseClient
            .from('user_roles')
            .select('*')
            .eq('user_id', userId);
            
          if (fetchError) throw fetchError;
          
          // Remove all existing roles for this user
          if (currentRoles.length > 0) {
            const { error: deleteError } = await supabaseClient
              .from('user_roles')
              .delete()
              .eq('user_id', userId);
              
            if (deleteError) throw deleteError;
          }
          
          // Add the new role
          const { error: insertError } = await supabaseClient
            .from('user_roles')
            .insert({
              user_id: userId,
              role: newRole
            });
            
          if (insertError) throw insertError;
          
          // Also update the profile table for compatibility
          const { error: profileError } = await supabaseClient
            .from('profiles')
            .update({ role: newRole })
            .eq('id', userId);
            
          if (profileError) {
            console.error('Error updating profile role:', profileError);
            // Don't fail if profile update fails
          }
          
          alert('Role updated successfully');
          
          // If we updated the current user's role, refresh their roles
          if (userId === this.currentUser.id) {
            await this.fetchUserRoles();
          }
          
          await this.fetchUsers();
        } catch (error) {
          console.error('Error updating role:', error);
          alert('Failed to update role: ' + error.message);
        }
      }
      
      async createNewRole(roleName, roleDescription, roleColor) {
        try {
          // Check if role already exists in our custom roles
          if (this.customRoles.some(role => role.name.toLowerCase() === roleName.toLowerCase())) {
            alert('Role with this name already exists');
            return false;
          }
          
          // Add new role to custom roles
          this.customRoles.push({
            name: roleName,
            description: roleDescription,
            color: roleColor
          });
          
          // Save to localStorage
          this.saveCustomRoles();
          
          // Close modal and refresh
          this.closeRoleModal();
          this.render();
          
          return true;
        } catch (error) {
          console.error('Error creating role:', error);
          alert('Failed to create role: ' + error.message);
          return false;
        }
      }
      
      deleteRole(roleName) {
        // Don't allow deleting default roles
        if (this.defaultRoles.some(role => role.name === roleName)) {
          alert('Cannot delete default roles');
          return false;
        }
        
        // Confirm deletion
        if (!confirm(`Are you sure you want to delete the "${roleName}" role?`)) {
          return false;
        }
        
        // Remove role from custom roles
        this.customRoles = this.customRoles.filter(role => role.name !== roleName);
        
        // Save to localStorage
        this.saveCustomRoles();
        
        // Update any users with this role to default 'user' role
        this.users.forEach(async user => {
          if (user.role === roleName) {
            await this.updateRole(user.id, 'user');
          }
        });
        
        this.render();
        return true;
      }
      
      openRoleModal() {
        document.getElementById('roleModal').classList.remove('hidden');
      }
      
      closeRoleModal() {
        document.getElementById('roleModal').classList.add('hidden');
        // Clear form
        document.getElementById('roleName').value = '';
        document.getElementById('roleDescription').value = '';
        document.getElementById('roleColor').value = 'blue';
      }
      
      setupModalEventListeners() {
        document.getElementById('cancelRoleBtn').addEventListener('click', () => {
          this.closeRoleModal();
        });
        
        document.getElementById('saveRoleBtn').addEventListener('click', async () => {
          const roleName = document.getElementById('roleName').value.trim();
          const roleDescription = document.getElementById('roleDescription').value.trim();
          const roleColor = document.getElementById('roleColor').value;
          
          if (!roleName) {
            alert('Role name is required');
            return;
          }
          
          if (await this.createNewRole(roleName, roleDescription, roleColor)) {
            alert('Role created successfully');
          }
        });
        
        // Close modal when clicking outside
        document.getElementById('roleModal').addEventListener('click', (e) => {
          if (e.target.id === 'roleModal') {
            this.closeRoleModal();
          }
        });
      }
      
      getRoleBadgeClass(roleColor) {
        switch (roleColor) {
          case 'red': return 'bg-red-100 text-red-800';
          case 'yellow': return 'bg-yellow-100 text-yellow-800';
          case 'green': return 'bg-green-100 text-green-800';
          case 'blue': return 'bg-blue-100 text-blue-800';
          case 'purple': return 'bg-purple-100 text-purple-800';
          case 'indigo': return 'bg-indigo-100 text-indigo-800';
          case 'pink': return 'bg-pink-100 text-pink-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      }
      
      async signIn() {
        const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'github' });
        if (error) alert('Login failed: ' + error.message);
      }
      
      async signOut() {
        await supabaseClient.auth.signOut();
        this.currentUser = null;
        this.currentRoles = [];
        this.users = [];
        this.render();
      }
      
      navigateTo(page) {
        this.currentPage = page;
        this.render();
      }
      
      renderDashboard() {
        return `
          <div class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-bold mb-4">Dashboard</h2>
            <p class="mb-4">Welcome to the Look4Blood dashboard. Here you can manage users, roles, and access different features based on your permissions.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-800">Total Users</h3>
                <p class="text-2xl font-bold">${this.users.length}</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-semibold text-green-800">Total Roles</h3>
                <p class="text-2xl font-bold">${this.roles.length}</p>
              </div>
              <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-semibold text-purple-800">Your Role</h3>
                <p class="text-2xl font-bold">${this.currentRoles.join(', ') || 'user'}</p>
              </div>
            </div>
            
            <div class="space-y-2">
              ${this.currentRoles.includes('admin') ? `
                <button onclick="app.navigateTo('users')" class="w-full text-left px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                  </svg>
                  User Management
                </button>
              ` : ''}
              
              ${this.currentRoles.includes('admin') || this.currentRoles.includes('moderator') ? `
                <button onclick="app.navigateTo('donors')" class="w-full text-left px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                  </svg>
                  Donor Management
                </button>
              ` : ''}
              
              ${this.currentRoles.includes('user') ? `
                <button onclick="app.navigateTo('profile')" class="w-full text-left px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                  </svg>
                  My Profile
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      renderUsers() {
        if (!this.currentRoles.includes('admin')) {
          return '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">You do not have permission to access this page.</div>';
        }
        
        return `
          <div class="bg-white p-6 rounded shadow space-y-4">
            <div class="flex justify-between items-center">
              <h1 class="text-xl font-bold">User Management</h1>
              <button class="text-sm text-red-600 underline hover:text-red-800 transition" id="logoutBtn">Logout</button>
            </div>
            
            <div class="flex justify-between items-center mb-4">
              <div class="flex space-x-2">
                <button onclick="app.navigateTo('dashboard')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                  </svg>
                  Back
                </button>
                <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                  </svg>
                  Refresh Users
                </button>
                <button id="addRoleBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                  </svg>
                  Add Role
                </button>
              </div>
              <div class="text-sm text-gray-600">
                Total Users: <strong>${this.users.length}</strong> | 
                Total Roles: <strong>${this.roles.length}</strong>
              </div>
            </div>
            
            <div class="mb-6">
              <h2 class="text-lg font-semibold mb-2">Available Roles</h2>
              <div class="flex flex-wrap gap-2">
                ${this.getAllRoles().map(role => `
                  <div class="relative group">
                    <span class="px-3 py-1 text-xs rounded-full ${this.getRoleBadgeClass(role.color)} flex items-center">
                      ${role.name}
                      ${!this.defaultRoles.some(dr => dr.name === role.name) ? `
                        <button class="ml-2 text-red-500 hover:text-red-700" onclick="app.deleteRole('${role.name}')">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                          </svg>
                        </button>
                      ` : ''}
                    </span>
                    <div class="absolute hidden group-hover:block z-10 w-64 p-2 mt-1 text-xs text-white bg-gray-800 rounded shadow-lg">
                      ${role.description}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            ${this.isLoading ? `
              <div class="flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600"></div>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="border border-gray-300 px-3 py-2 text-left">Name</th>
                      <th class="border border-gray-300 px-3 py-2 text-left">Email</th>
                      <th class="border border-gray-300 px-3 py-2 text-left">Role</th>
                      <th class="border border-gray-300 px-3 py-2 text-left">All Roles</th>
                      <th class="border border-gray-300 px-3 py-2 text-left">Joined</th>
                      <th class="border border-gray-300 px-3 py-2 text-left">Change Role</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${this.users.length > 0 ? this.users.map(user => `
                      <tr class="border border-gray-300 hover:bg-gray-50">
                        <td class="px-3 py-2">${user.full_name || 'N/A'}</td>
                        <td class="px-3 py-2">${user.email}</td>
                        <td class="px-3 py-2">
                          <span class="px-2 py-1 text-xs rounded-full ${this.getRoleBadgeClass(user.roleColor)}">
                            ${user.role}
                          </span>
                        </td>
                        <td class="px-3 py-2">
                          ${user.allRoles.map(role => {
                            const roleInfo = this.getAllRoles().find(r => r.name === role) || 
                                           { name: role, description: 'Custom role', color: 'blue' };
                            return `<span class="px-2 py-1 text-xs rounded-full ${this.getRoleBadgeClass(roleInfo.color)}">${role}</span>`;
                          }).join(' ')}
                        </td>
                        <td class="px-3 py-2">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-3 py-2">
                          <select data-user-id="${user.id}" class="role-select border rounded px-2 py-1 text-sm">
                            ${this.roles.map(role => `
                              <option value="${role.name}" ${user.role === role.name ? 'selected' : ''}>${role.name}</option>
                            `).join('')}
                          </select>
                        </td>
                      </tr>
                    `).join('') : `
                      <tr>
                        <td colspan="6" class="px-3 py-4 text-center text-gray-500">No users found</td>
                      </tr>
                    `}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;
      }
      
      renderDonors() {
        if (!this.currentRoles.includes('admin') && !this.currentRoles.includes('moderator')) {
          return '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">You do not have permission to access this page.</div>';
        }
        
        return `
          <div class="bg-white p-6 rounded shadow space-y-4">
            <div class="flex justify-between items-center">
              <h1 class="text-xl font-bold">Donor Management</h1>
              <button class="text-sm text-red-600 underline hover:text-red-800 transition" id="logoutBtn">Logout</button>
            </div>
            
            <div class="flex justify-between items-center mb-4">
              <button onclick="app.navigateTo('dashboard')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back
              </button>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-semibold text-blue-800 mb-2">Donor Management</h3>
              <p>This section is accessible to admins and moderators. Here you can manage blood donors, donation events, and blood inventory.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold mb-2">Recent Donations</h3>
                <p class="text-gray-600">No recent donations to display.</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold mb-2">Upcoming Events</h3>
                <p class="text-gray-600">No upcoming events scheduled.</p>
              </div>
            </div>
          </div>
        `;
      }
      
      renderProfile() {
        return `
          <div class="bg-white p-6 rounded shadow space-y-4">
            <div class="flex justify-between items-center">
              <h1 class="text-xl font-bold">My Profile</h1>
              <button class="text-sm text-red-600 underline hover:text-red-800 transition" id="logoutBtn">Logout</button>
            </div>
            
            <div class="flex justify-between items-center mb-4">
              <button onclick="app.navigateTo('dashboard')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back
              </button>
            </div>
            
            <div class="space-y-4">
              <div>
                <h2 class="text-lg font-semibold mb-2">Personal Information</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p><strong>Name:</strong> ${this.currentUser.user_metadata?.full_name || 'N/A'}</p>
                  <p><strong>Email:</strong> ${this.currentUser.email}</p>
                  <p><strong>Role:</strong> ${this.currentRoles.join(', ') || 'user'}</p>
                  <p><strong>Member Since:</strong> ${new Date(this.currentUser.created_at).toLocaleDateString()}</p>
                </div>
              </div>
              
              <div>
                <h2 class="text-lg font-semibold mb-2">Donation History</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-gray-600">No donation history available.</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      render() {
        const app = document.getElementById('app');
        
        if (!this.currentUser) {
          app.innerHTML = `
            <div class="text-center p-6 bg-white rounded shadow">
              <h1 class="text-2xl font-bold mb-4">Welcome to Look4Blood</h1>
              <button class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition" id="loginBtn">Login with GitHub</button>
            </div>
          `;
          document.getElementById('loginBtn').onclick = () => this.signIn();
          return;
        }
        
        // Render based on current page
        switch (this.currentPage) {
          case 'users':
            app.innerHTML = this.renderUsers();
            break;
          case 'donors':
            app.innerHTML = this.renderDonors();
            break;
          case 'profile':
            app.innerHTML = this.renderProfile();
            break;
          default:
            app.innerHTML = this.renderDashboard();
            break;
        }
        
        // Set up common event listeners
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.onclick = () => this.signOut();
        }
        
        if (this.currentPage === 'users' && this.currentRoles.includes('admin')) {
          document.getElementById('refreshBtn').onclick = async () => {
            await this.fetchUsers();
          };
          
          document.getElementById('addRoleBtn').onclick = () => {
            this.openRoleModal();
          };
          
          if (!this.isLoading) {
            document.querySelectorAll('.role-select').forEach(select => {
              select.addEventListener('change', async (e) => {
                const userId = e.target.dataset.userId;
                const newRole = e.target.value;
                await this.updateRole(userId, newRole);
              });
            });
          }
        }
      }
    }
    
    const app = new UserRoleManager();
    app.init();
  </script>
</body>
</html>

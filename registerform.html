<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blood Donor Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #e53935;
      --primary-dark: #c62828;
      --primary-light: #ffcdd2;
      --secondary-color: #f5f5f5;
      --text-color: #333333;
      --error-color: #c62828;
      --success-color: #2e7d32;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text-color);
    }
    .container {
      width: 100%;
      max-width: 600px;
      position: relative;
    }
    .form-header {
      background: var(--primary-color);
      color: white;
      padding: 25px 30px;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      text-align: center;
      position: relative;
    }
    .form-header h2 {
      font-weight: 600;
      font-size: 24px;
      margin-bottom: 5px;
    }
    .form-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    form {
      background: white;
      padding: 30px;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      width: 100%;
      box-shadow: var(--box-shadow);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text-color);
    }
    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1);
    }
    .location-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    @media (min-width: 768px) {
      .location-group {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    button[type="submit"] {
      background: var(--primary-color);
      color: white;
      padding: 14px;
      border: none;
      width: 100%;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    button[type="submit"]:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    button[type="submit"]:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
    }
    .checkbox-group {
      margin-top: 20px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-top: 3px;
    }
    .checkbox-group label {
      display: inline;
      font-weight: normal;
      font-size: 13px;
      line-height: 1.4;
    }
    .login-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
    }
    .login-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }
    .login-link a:hover {
      text-decoration: underline;
    }
    .success {
      text-align: center;
      margin-top: 15px;
      color: var(--success-color);
      font-weight: 500;
    }
    .error {
      text-align: center;
      margin-top: 15px;
      color: var(--error-color);
      font-weight: 500;
    }
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 20px;
      flex-direction: column;
      font-family: 'Poppins', sans-serif;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .blood-drop {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: var(--primary-color);
      border-radius: 50% 50% 50% 0;
      transform: translateX(-50%) rotate(45deg);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .blood-drop::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 10px;
      left: 10px;
      transform: rotate(-45deg);
    }
    .blood-drop::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      top: 15px;
      left: 15px;
      transform: rotate(-45deg);
    }
    .form-footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-style: italic;
      color: #666;
      font-size: 13px;
    }
    .required::after {
      content: " *";
      color: var(--error-color);
    }
    .lang-toggle {
      margin-top: 25px;
      text-align: center;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .lang-toggle button {
      background: #e0e0e0;
      color: #333;
      border: none;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .lang-toggle button:hover {
      background: #d0d0d0;
    }
    .lang-toggle button.active {
      background: var(--primary-color);
      color: white;
    }
    .debug-info {
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      font-size: 12px;
      color: #666;
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="form-header">
    <div class="blood-drop"></div>
    <h2 data-en="Donor Registration" data-bn="রক্তদাতার নিবন্ধন">Donor Registration</h2>
    <p data-en="Join our life-saving community" data-bn="আমাদের জীবন রক্ষাকারী সম্প্রদায়ে যোগ দিন">Join our life-saving community</p>
  </div>
  <form id="donor-form" name="donor-form">
    <div class="form-group">
      <label data-en="Full Name" data-bn="পূর্ণ নাম" class="required">Full Name</label>
      <input type="text" name="name" required>
    </div>
    <div class="form-group">
      <label data-en="Age" data-bn="বয়স" class="required">Age</label>
      <input type="number" name="age" required>
    </div>
    <div class="form-group">
      <label data-en="Gender" data-bn="লিঙ্গ" class="required">Gender</label>
      <select name="gender" required>
        <option value="">Select</option>
        <option data-en="Male" data-bn="পুরুষ">Male</option>
        <option data-en="Female" data-bn="মহিলা">Female</option>
        <option data-en="Other" data-bn="অন্যান্য">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label data-en="Blood Group" data-bn="রক্তের গ্রুপ" class="required">Blood Group</label>
      <select name="bloodGroup" required>
        <option value="">Select</option>
        <option>A+</option><option>A-</option>
        <option>B+</option><option>B-</option>
        <option>AB+</option><option>AB-</option>
        <option>O+</option><option>O-</option>
      </select>
    </div>
    <div class="form-group">
      <label data-en="Phone Number" data-bn="ফোন নম্বর" class="required">Phone Number</label>
      <input type="tel" name="phone" required>
    </div>
    <div class="form-group">
      <label data-en="Email" data-bn="ইমেইল" class="required">Email</label>
      <input type="email" name="email" required>
    </div>
    <div class="form-group">
      <label data-en="Password" data-bn="পাসওয়ার্ড" class="required">Password</label>
      <input type="password" name="password" minlength="6" required>
    </div>
    <div class="location-group">
      <div class="form-group">
        <label data-en="Division" data-bn="বিভাগ" class="required">Division / বিভাগ</label>
        <select id="division" name="division" required>
          <option value="">Select Division</option>
        </select>
      </div>
      <div class="form-group">
        <label data-en="District" data-bn="জেলা" class="required">District / জেলা</label>
        <select id="district" name="district" disabled required>
          <option value="">Select District</option>
        </select>
      </div>
      <div class="form-group">
        <label data-en="City" data-bn="শহর" class="required">City / শহর</label>
        <select id="city" name="city" disabled required>
          <option value="">Select City</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label data-en="Last Donation Date" data-bn="শেষ রক্তদান তারিখ">Last Donation Date</label>
      <input type="date" name="lastDonation">
    </div>
    <div class="form-group">
      <label data-en="How many times donated before?" data-bn="পূর্বে কতবার রক্তদান করেছেন?">How many times donated before?</label>
      <input type="number" name="donationCount" min="0">
    </div>
    <div class="form-group">
      <label data-en="Are you willing to donate blood?" data-bn="আপনি কি রক্তদান করতে আগ্রহী?" class="required">Are you willing to donate blood?</label>
      <select name="available" required>
        <option value="">Select</option>
        <option data-en="Yes" data-bn="হ্যাঁ">Yes</option>
        <option data-en="No" data-bn="না">No</option>
      </select>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="terms" name="terms" required>
      <label for="terms" data-en="I agree to the Terms and Conditions: Please do not fill out false information. This is a matter of saving lives. Be honest and responsible." data-bn="আমি শর্তাবলীতে সম্মত: অনুগ্রহ করে ভুল তথ্য প্রদান করবেন না। এটি একটি জীবন রক্ষার বিষয়। দয়া করে সৎ এবং দায়িত্বশীল হোন।">
        I agree to the Terms and Conditions...
      </label>
    </div>
    <div class="form-footer">
      <p data-en="Your blood can be someone's second chance at life. Be the reason someone smiles today." data-bn="আপনার রক্ত কারো জীবনের দ্বিতীয় সুযোগ হতে পারে। কারো মুখে হাসি ফোটাতে সাহায্য করুন।">
        Your blood can be someone's second chance at life...
      </p>
    </div>
    <button type="submit" data-en="Register" data-bn="নিবন্ধন করুন">Register</button>
    
    <div class="login-link">
      <span data-en="Already have an account?" data-bn="ইতিমধ্যে একটি অ্যাকাউন্ট আছে?">Already have an account?</span>
      <a href="userlogin.html" data-en="Login here" data-bn="এখানে লগইন করুন">Login here</a>
    </div>
    
    <div class="lang-toggle">
      <button type="button" class="active" onclick="setLang('en')">English</button>
      <button type="button" onclick="setLang('bn')">বাংলা</button>
    </div>
    
    <div class="success" id="success-msg"></div>
    <div class="error" id="error-msg"></div>
    <div class="debug-info" id="debug-info"></div>
  </form>
</div>
<div id="loading-overlay">
  <div class="spinner" style="border:6px solid #f3f3f3;border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;"></div>
  <div style="margin-top:10px;">Processing...</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Initialize Supabase
  const SUPABASE_URL = "https://bbvyjeljeyofswuijlyg.supabase.co";
  const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_API_KEY);
  
  // Function to send welcome SMS using BulkSMSBD API
  async function sendWelcomeSMS(phoneNumber) {
    // API configuration - replace with your actual API key and sender ID
    const apiKey = "tnKcakTI7mBbSJQoob0T"; // Replace with your actual API key
    const senderId = "8809617623984"; // Replace with your actual sender ID
    const message = "Welcome to Look4Blood! ❤️ Thank you for registering as a life-saving blood donor.";
    
    // Format phone number to ensure it has the country code (assuming Bangladesh)
    let formattedPhone = phoneNumber.trim();
    if (!formattedPhone.startsWith('880')) {
      if (formattedPhone.startsWith('01')) {
        formattedPhone = '88' + formattedPhone;
      } else if (formattedPhone.startsWith('+88')) {
        formattedPhone = formattedPhone.substring(1);
      }
    }
    
    // Prepare the request data
    const smsData = {
      api_key: apiKey,
      senderid: senderId,
      messages: [
        {
          to: formattedPhone,
          message: message
        }
      ]
    };
    
    // Show debug info
    const debugInfo = document.getElementById('debug-info');
    debugInfo.style.display = 'block';
    debugInfo.innerHTML = `
      <strong>SMS Debug Information:</strong><br>
      Phone: ${formattedPhone}<br>
      Message: ${message}<br>
      API Endpoint: http://bulksmsbd.net/api/smsapimany<br>
      Request Data: ${JSON.stringify(smsData, null, 2)}
    `;
    
    try {
      console.log('Sending SMS to:', formattedPhone);
      console.log('Request data:', JSON.stringify(smsData));
      
      // Try different request formats
      let response;
      
      // First attempt: JSON format
      try {
        response = await fetch('http://bulksmsbd.net/api/smsapimany', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(smsData)
        });
      } catch (jsonError) {
        console.warn('JSON request failed, trying form data:', jsonError);
        
        // Second attempt: Form data format
        const formData = new FormData();
        formData.append('api_key', apiKey);
        formData.append('senderid', senderId);
        formData.append('messages', JSON.stringify(smsData.messages));
        
        response = await fetch('http://bulksmsbd.net/api/smsapimany', {
          method: 'POST',
          body: formData
        });
      }
      
      const result = await response.text();
      console.log('SMS API Response:', result);
      
      // Try to parse as JSON, if fails use text
      let resultObj;
      try {
        resultObj = JSON.parse(result);
      } catch (e) {
        resultObj = { response_text: result };
      }
      
      // Update debug info with response
      debugInfo.innerHTML += `<br><br><strong>Response:</strong><br>${result}`;
      
      // Check if response is successful
      if (response.ok && 
          (resultObj.response_code === 202 || 
           resultObj.response_code === 200 || 
           resultObj.success === true ||
           resultObj.response_text?.toLowerCase().includes('success'))) {
        console.log('SMS sent successfully:', resultObj);
        return { success: true, message: 'SMS sent successfully' };
      } else {
        console.error('SMS sending failed:', resultObj);
        return { 
          success: false, 
          message: resultObj.error_message || resultObj.response_text || 'Failed to send SMS' 
        };
      }
    } catch (error) {
      console.error('Error sending SMS:', error);
      
      // Update debug info with error
      debugInfo.innerHTML += `<br><br><strong>Error:</strong><br>${error.message}`;
      
      return { success: false, message: 'Error sending SMS: ' + error.message };
    }
  }
  
  function setLang(lang) {
    document.querySelectorAll('[data-en]').forEach(el => {
      el.textContent = el.getAttribute(`data-${lang}`);
    });
    document.querySelectorAll('.lang-toggle button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.lang-toggle button[onclick*="${lang}"]`).classList.add('active');
  }
  const form = document.forms['donor-form'];
  const successMsg = document.getElementById('success-msg');
  const errorMsg = document.getElementById('error-msg');
  const submitBtn = form.querySelector('button[type="submit"]');
  const loadingOverlay = document.getElementById('loading-overlay');
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzXTMAauYEzYhM-12zcf2pMJY4ZNh4kcbTDug1VX4mazMUYrR1k2QUHJyTtO0OawAnL/exec';
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    successMsg.textContent = '';
    errorMsg.textContent = '';
    document.getElementById('debug-info').style.display = 'none';
    
    if (!form.terms.checked) {
      errorMsg.textContent = "You must agree to the terms.";
      return;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = "Processing...";
    loadingOverlay.style.display = "flex";
    const formData = new FormData(form);
const body = {};
formData.forEach((value, key) => body[key] = value);
// Generate custom_id once and reuse it
const customId = `L4B-${Math.random().toString(36).substring(2,6).toUpperCase()}${Date.now().toString().slice(-2)}`;
body.custom_id = customId;
body.userId = customId;
try {
  // Step 1: Create Supabase Auth user with minimal signup
  const { data, error } = await supabase.auth.signUp({
    email: body.email,
    password: body.password
  });
  if (error) {
    throw new Error(`Authentication failed: ${error.message}`);
  }
  // Step 2: Prepare data for database (exclude password)
  const donorData = {
    user_id: data.user.id,              // Use Supabase user ID
    custom_id: customId,                // Use generated custom ID
    name: body.name,
    age: Number(body.age),
    gender: body.gender,
    blood_group: body.bloodGroup,
    phone: body.phone,
    email: body.email,
    division: body.division,
    state: body.district,
    city: body.city,
    last_donation: body.lastDonation || null,
    times_donated: Number(body.donationCount) || 0,
    available: body.available === "Yes",
    terms: true
  };
  
      // Step 3: Send to Supabase donors table
      const { error: dbError } = await supabase
        .from('donors')
        .insert(donorData);
      if (dbError) {
        throw new Error(`Database error: ${dbError.message}`);
      }
      // Step 4: Send to Google Sheets (exclude password)
      const googleFormData = new FormData();
      Object.keys(body).forEach(key => {
        if (key !== 'password') {
          googleFormData.append(key, body[key]);
        }
      });
      const googleResponse = await fetch(scriptURL, { 
        method: 'POST', 
        body: googleFormData 
      });
      if (!googleResponse.ok) {
        throw new Error('Google Sheets submission failed');
      }
      
      // Step 5: Send welcome SMS
      const smsResult = await sendWelcomeSMS(body.phone);
      if (!smsResult.success) {
        console.warn('SMS sending failed, but registration was successful:', smsResult.message);
        // We don't throw an error here since the main registration was successful
      }
      
      successMsg.textContent = "✅ Registration successful!";
      form.reset();
      setLang('en');
      setTimeout(() => {
        window.location.href = '#index.html';
      }, 2000);
    } catch (err) {
      errorMsg.textContent = `❌ Error: ${err.message}`;
      console.error('Registration error:', err);
    } finally {
      loadingOverlay.style.display = "none";
      submitBtn.disabled = false;
      submitBtn.textContent = "Register";
    }
  });
  // Load the dropdowns from Supabase
async function loadDivisions() {
    const { data: locations, error } = await supabase
        .from("locations")
        .select("division")
        .order("division");
    if (error || !locations) {
        console.error('Error loading divisions:', error);
        return;
    }
    const uniqueDivisions = [...new Set(locations.map(l => l.division))];
    const divisionSelect = document.getElementById("division");
    divisionSelect.innerHTML = '<option value="">Select Division</option>';
    uniqueDivisions.forEach(division => {
        divisionSelect.innerHTML += `<option value="${division}">${division}</option>`;
    });
}
// Load districts based on selected division
async function loadDistricts(selectedDivision) {
    const { data: locations, error } = await supabase
        .from("locations")
        .select("district")
        .eq("division", selectedDivision)
        .order("district");
    if (error || !locations) {
        console.error('Error loading districts:', error);
        return;
    }
    const uniqueDistricts = [...new Set(locations.map(l => l.district))];
    const districtSelect = document.getElementById("district");
    districtSelect.innerHTML = '<option value="">Select District</option>';
    districtSelect.disabled = false;
    uniqueDistricts.forEach(district => {
        districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
    });
    // Reset city dropdown
    const citySelect = document.getElementById("city");
    citySelect.innerHTML = '<option value="">Select City</option>';
    citySelect.disabled = true;
}
// Load cities based on selected district
async function loadCities(selectedDistrict) {
    const division = document.getElementById("division").value;
    const { data: locations, error } = await supabase
        .from("locations")
        .select("city")
        .eq("division", division)
        .eq("district", selectedDistrict)
        .order("city");
    if (error || !locations) {
        console.error('Error loading cities:', error);
        return;
    }
    const uniqueCities = [...new Set(locations.map(l => l.city))];
    const citySelect = document.getElementById("city");
    citySelect.innerHTML = '<option value="">Select City</option>';
    citySelect.disabled = false;
    uniqueCities.forEach(city => {
        citySelect.innerHTML += `<option value="${city}">${city}</option>`;
    });
}
// Event listener for division change
document.getElementById("division").addEventListener("change", (e) => {
    const selectedDivision = e.target.value;
    if (selectedDivision) {
        loadDistricts(selectedDivision);
    } else {
        // Reset district and city
        document.getElementById("district").innerHTML = '<option value="">Select District</option>';
        document.getElementById("district").disabled = true;
        document.getElementById("city").innerHTML = '<option value="">Select City</option>';
        document.getElementById("city").disabled = true;
    }
});
// Event listener for district change
document.getElementById("district").addEventListener("change", (e) => {
    const selectedDistrict = e.target.value;
    if (selectedDistrict) {
        loadCities(selectedDistrict);
    } else {
        // Reset city
        document.getElementById("city").innerHTML = '<option value="">Select City</option>';
        document.getElementById("city").disabled = true;
    }
});
// Load initial divisions when page loads
loadDivisions();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Donor Profile - Look4Blood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        :root {
            --primary-red: #c62828;
            --primary-red-dark: #b71c1c;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #334155;
        }
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(198, 40, 40, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-red);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Comment Section */
        .comment-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .comment-section.open {
            max-height: 500px;
        }
        /* Table styles */
        .donation-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .donation-table th, .donation-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .donation-table th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .donation-table tr:hover {
            background-color: #f8fafc;
        }
        /* Card Styles */
        .profile-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.1), 0 15px 15px -5px rgba(0, 0, 0, 0.04);
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: all 0.3s ease;
            border-top: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-red), #e91e63, #9c27b0);
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(198, 40, 40, 0.4);
        }
        .btn-secondary {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.4);
        }
        .btn-admin {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.4);
        }
        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            font-family: inherit;
            color: #334155;
            background: white;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
            transform: translateY(-1px);
        }
        .form-input:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        .form-input:disabled {
            background-color: #f8fafc;
            color: #94a3b8;
            cursor: not-allowed;
            pointer-events: none;
        }
        .form-input.error {
            border-color: #ef4444;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-blood {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #b91c1c;
        }
        .badge-age {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
        }
        .badge-admin {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
        }
        .badge-moderator {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
        }
        /* Donation Badge Styles */
        .donation-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            border: 3px solid white;
            transition: all 0.3s ease;
        }
        .donation-badge:hover {
            transform: scale(1.1);
        }
        .badge-bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            box-shadow: 0 6px 12px rgba(205, 127, 50, 0.4);
        }
        .badge-silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
            box-shadow: 0 6px 12px rgba(192, 192, 192, 0.4);
        }
        .badge-gold {
            background: linear-gradient(135deg, #FFD700, #B8860B);
            box-shadow: 0 6px 12px rgba(255, 215, 0, 0.4);
        }
        .badge-platinum {
            background: linear-gradient(135deg, #E5E4E2, #B0C4DE);
            box-shadow: 0 6px 12px rgba(176, 196, 222, 0.4);
        }
        .badge-diamond {
            background: linear-gradient(135deg, #B9F2FF, #87CEEB);
            box-shadow: 0 6px 12px rgba(135, 206, 235, 0.4);
        }
        .badge-red-diamond {
            background: linear-gradient(135deg, #FF6B6B, #E0115F);
            box-shadow: 0 6px 12px rgba(224, 17, 95, 0.4);
        }
        /* Add a pulsing animation for the highest badge */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(224, 17, 95, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(224, 17, 95, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(224, 17, 95, 0);
            }
        }
        .badge-red-diamond {
            animation: pulse 2s infinite;
        }
        /* Next Badge Styles */
        .next-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .next-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.1);
        }
        .next-badge-text {
            font-size: 0.875rem;
            color: #64748b;
            margin-left: 0.5rem;
            font-weight: 500;
        }
        /* Badge Info Container */
        #badgeInfoContainer {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        #badgeInfoContainer:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.1);
        }
        /* Star Rating Styles */
        .star-rating {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .star {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star:hover,
        .star.active {
            color: #ffc107;
        }
        .rating-info {
            text-align: center;
            margin-top: 0.5rem;
        }
        .rating-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .rating-text {
            color: #666;
            font-size: 0.9rem;
        }
        .total-star-count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .rating-actions {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        .btn-give-rating {
            display: none;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-give-rating:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(255, 193, 7, 0.4);
        }
        .btn-give-rating.show {
            display: inline-flex;
        }
        /* Cropper styles */
        .cropper-container {
            max-height: 400px;
        }
        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 50%;
            cursor: pointer;
        }
        .profile-photo-container:hover .upload-overlay {
            opacity: 1;
        }
        /* Success Toast */
        .success-toast {
            position: fixed;
            bottom: 4rem;
            right: 4px;
            background: green;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* Location dropdown styles */
        .location-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .location-dropdowns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
       
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info-grid {
                grid-template-columns: 1fr;
            }
            
            .star {
                font-size: 1.8rem;
            }
            
            .location-dropdowns {
                grid-template-columns: 1fr;
            }
            
            /* Responsive action buttons */
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.75rem;
            }
            
            .action-buttons .btn {
                flex: 1 1 calc(50% - 0.75rem);
                min-width: 140px;
                justify-content: center;
            }
            
            /* Adjust badge position for mobile */
            .badge-admin, .badge-moderator {
                top: 10px;
                right: 10px;
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Admin/Moderator Badge (will be shown conditionally) -->
    <div id="roleBadge" class="hidden"></div>
    
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Profile Header -->
        <div class="profile-card mb-8 p-6 md:p-8 fade-in">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
                <!-- Profile Photo -->
                <div class="profile-photo-container relative">
                    <img id="profilePhoto" src="" 
                         alt="Profile" class="w-40 h-40 rounded-full object-cover border-4 border-white shadow-lg">
                    <div class="upload-overlay">
                        <div class="text-white text-center">
                            <i class="fas fa-camera text-2xl mb-2"></i>
                            <p class="text-sm">Change Photo</p>
                        </div>
                    </div>
                    <!-- Donation Badge -->
                    <div id="donationBadge" class="donation-badge badge-bronze">
                        <i class="fas fa-medal text-white text-xl"></i>
                    </div>
                    <input type="file" id="photoUpload" class="hidden" accept="image/*">
                </div>
                
                <!-- Basic Info -->
                <div class="flex-1 text-center md:text-left">
                    <h1 id="userName" class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">Loading...</h1>
                    <div class="flex flex-wrap justify-center md:justify-start gap-3 mb-4">
                        <span id="bloodGroup" class="badge badge-blood">
                            <i class="fas fa-tint mr-1"></i> A+
                        </span>
                        <span id="userAge" class="badge badge-age">
                            <i class="fas fa-user mr-1"></i> 27 years
                        </span>
                    </div>
                    <p class="text-gray-600 max-w-2xl">
                        Dedicated blood donor committed to saving lives through regular donations. 
                        Every donation can help save up to three lives.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Stats Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Left Side - Donation Stats -->
            <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-chart-line text-red-500 mr-2"></i>Donation History
                    </h2>
                    <button id="donationHistoryBtn" class="btn btn-info">
                        <i class="fas fa-history"></i> View All
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 font-medium">
                            <i class="fas fa-hand-holding-heart text-red-500 mr-2"></i>Total Donations
                        </span>
                        <span id="totalDonations" class="text-3xl font-bold text-red-500">0</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 font-medium">
                            <i class="fas fa-calendar-check text-green-500 mr-2"></i>Last Donation
                        </span>
                        <span id="lastDonation" class="text-xl font-semibold text-gray-800">Never</span>
                    </div>
                    
                    <!-- Progress Circle -->
                    <div class="flex flex-col items-center mt-8">
                        <div class="relative w-48 h-48">
                            <svg class="progress-ring w-48 h-48">
                                <circle class="text-gray-200" stroke="currentColor" stroke-width="10" 
                                        fill="transparent" r="86" cx="96" cy="96"/>
                                <circle id="progressCircle" class="progress-ring__circle text-red-500" 
                                        stroke="currentColor" stroke-width="10" fill="transparent" 
                                        r="86" cx="96" cy="96"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="progressPercent" class="text-3xl font-bold text-gray-800">0%</span>
                                <span class="text-sm text-gray-500">Progress</span>
                            </div>
                        </div>
                        <p id="nextDonationText" class="mt-6 text-center text-gray-600 font-medium">
                            You will be eligible to donate in 
                            <span class="font-bold text-red-500">90 days</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Interactions -->
            <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-users text-blue-500 mr-2"></i>Community Feedback
                </h2>
                
                <!-- Star Rating -->
                <div class="star-rating" id="starRating">
                    <i class="fas fa-star star" data-rating="1"></i>
                    <i class="fas fa-star star" data-rating="2"></i>
                    <i class="fas fa-star star" data-rating="3"></i>
                    <i class="fas fa-star star" data-rating="4"></i>
                    <i class="fas fa-star star" data-rating="5"></i>
                </div>
                
                <div class="rating-actions">
                    <button id="giveRatingBtn" class="btn btn-give-rating">
                        <i class="fas fa-star mr-2"></i> Give Rating
                    </button>
                </div>
                
                <div class="rating-info">
                    <div id="averageRating" class="rating-count">0.0</div>
                    <div id="ratingCount" class="rating-text">0 ratings</div>
                    <div id="totalStarCount" class="total-star-count">Total stars: 0</div>
                </div>
                
                <div class="space-y-3 mt-6">
                    <button id="commentBtn" class="btn btn-primary w-full justify-center">
                        <i class="fas fa-comment"></i> View Comments
                    </button>
                    
                    <button id="reportBtn" class="btn btn-warning w-full justify-center">
                        <i class="fas fa-flag"></i> Report Profile
                    </button>
                </div>
                
                <!-- Next Badge -->
                <div id="nextBadge" class="next-badge">
                    <i class="fas fa-medal text-yellow-500"></i>
                    <span class="next-badge-text">Next badge: Silver (4 donations)</span>
                </div>
                
                <!-- Comments Section -->
                <div id="commentsSection" class="comment-section mt-6">
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-comments text-blue-500 mr-2"></i> Comments
                        </h3>
                        <div id="commentsList" class="space-y-4 max-h-60 overflow-y-auto mb-4">
                            <!-- Comments will be loaded here -->
                        </div>
                        <div class="flex space-x-2">
                            <input id="commentInput" type="text" placeholder="Add a comment..." 
                                   class="form-input flex-1">
                            <button id="addCommentBtn" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Info Section -->
        <div class="stat-card mb-8 fade-in" style="animation-delay: 0.3s;">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-user-circle text-purple-500 mr-2"></i> Contact Information
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-phone text-blue-500 mr-1"></i> Phone Number
                        </label>
                        <input id="phoneInput" type="tel" readonly 
                               class="form-input" maxlength="11">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-envelope text-blue-500 mr-1"></i> Email
                        </label>
                        <input id="emailInput" type="email" readonly 
                               class="form-input bg-gray-100">
                    </div>
                    
                    <!-- Location Dropdowns -->
                    <div class="location-group">
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt text-red-500 mr-1"></i> Location
                        </label>
                        <div class="location-dropdowns">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Division</label>
                                <select id="divisionInput" class="form-input" disabled>
                                    <option value="">Select Division</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">District</label>
                                <select id="districtInput" class="form-input" disabled>
                                    <option value="">Select District</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">City</label>
                                <select id="cityInput" class="form-input" disabled>
                                    <option value="">Select City</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-id-card text-yellow-500 mr-1"></i> Donor ID
                        </label>
                        <input id="customIdInput" type="text" readonly 
                               class="form-input bg-gray-100">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons flex justify-center space-x-4 mb-8 fade-in" style="animation-delay: 0.4s;">
            <button id="editBtn" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit Profile
            </button>
            <button id="saveBtn" class="btn btn-primary hidden">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button id="logoutBtn" class="btn btn-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <button id="shareBtn" class="btn btn-secondary">
                <i class="fas fa-share-alt"></i> Share Profile
            </button>
            <button id="adminPanelBtn" class="btn btn-admin hidden">
                <i class="fas fa-cogs"></i> Admin Panel
            </button>
        </div>
    </div>
    
    <!-- Crop Modal -->
    <div id="cropModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-crop text-blue-500 mr-2"></i> Crop Your Profile Picture
            </h3>
            <div class="mb-4">
                <img id="cropImage" class="max-w-full">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelCropBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="applyCropBtn" class="btn btn-primary">
                    <i class="fas fa-check"></i> Apply
                </button>
            </div>
        </div>
    </div>
    
    <!-- Donation History Modal -->
    <div id="donationHistoryModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-history text-blue-500 mr-2"></i> Donation History
                </h3>
                <button id="closeDonationHistoryBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="donation-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar mr-1"></i> Date</th>
                            <th><i class="fas fa-map-marker-alt mr-1"></i> Place</th>
                            <th><i class="fas fa-tint mr-1"></i> Blood Group</th>
                            <th><i class="fas fa-hashtag mr-1"></i> Donation #</th>
                        </tr>
                    </thead>
                    <tbody id="donationHistoryList">
                        <!-- Donation history will be loaded here -->
                    </tbody>
                </table>
                <div id="noDonationHistory" class="text-center py-12 text-gray-500 hidden">
                    <i class="fas fa-history text-5xl mb-4"></i>
                    <p class="text-lg">No donation history found</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-flag text-yellow-500 mr-2"></i> Report User
            </h3>
            <form id="reportForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> Reason
                    </label>
                    <select id="reportReason" class="form-input">
                        <option value="">Select a reason</option>
                        <option value="inappropriate">Inappropriate behavior</option>
                        <option value="fake">Fake profile</option>
                        <option value="spam">Spam</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment-alt text-yellow-500 mr-1"></i> Description
                    </label>
                    <textarea id="reportDescription" rows="4" 
                              class="form-input" placeholder="Please provide details about your report..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelReportBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Confirm Changes</h3>
                <p class="text-gray-600">Are you sure you want to save these changes to your profile?</p>
            </div>
            
            <div class="flex flex-col space-y-4">
                <button id="confirmSaveBtn" class="btn btn-primary w-full justify-center">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
                <button id="confirmCancelBtn" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-times mr-2"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Toast -->
    <div id="successToast" class="success-toast">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="successMessage">Success!</span>
    </div>
    
    <!-- Authentication Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-user-lock text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Authentication Required</h3>
                <p class="text-gray-600">Please log in or register on Look4Blood to view your profile.
Track your donation history, eligibility countdown, and feedback all in one place.</p>
            </div>
            
            <div class="flex flex-col space-y-4">
                <button id="modalLoginBtn" class="btn btn-primary w-full justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
                <button id="modalRegisterBtn" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-user-plus mr-2"></i> Register
                </button>
                <button id="modalCancelBtn" class="btn btn-secondary w-full justify-center">
                    <i class="fas fa-times mr-2"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://bbvyjeljeyofswuijlyg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Global variables
        let currentUser = null;
        let donorData = null;
        let userRating = null;
        let selectedRating = 0;
        let isEditMode = false;
        let cropper = null;
        let locations = [];
        let userRoles = [];
        let originalProfileData = {}; // Store original data for cancel functionality
        
        // Show success toast
        function showSuccessToast(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.add('show');
            
            setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Update donation badge based on donation count
        function updateDonationBadge(donationCount) {
            const badge = document.getElementById('donationBadge');
            const badgeIcon = badge.querySelector('i');
            
            // Remove all existing badge classes
            badge.classList.remove('badge-bronze', 'badge-silver', 'badge-gold', 'badge-platinum', 'badge-diamond', 'badge-red-diamond');
            
            // Reset icon
            badgeIcon.className = 'fas text-white text-xl';
            
            let currentBadgeName = '';
            let badgeDescription = '';
            
            if (donationCount >= 1 && donationCount <= 3) {
                badge.classList.add('badge-bronze');
                badgeIcon.classList.add('fa-hand-holding-heart');
                currentBadgeName = 'First Responder';
                badgeDescription = 'Beginning your journey to save lives';
            } else if (donationCount >= 4 && donationCount <= 15) {
                badge.classList.add('badge-silver');
                badgeIcon.classList.add('fa-heart');
                currentBadgeName = 'Life Saver';
                badgeDescription = 'Making a significant difference in the community';
            } else if (donationCount >= 16 && donationCount <= 20) {
                badge.classList.add('badge-gold');
                badgeIcon.classList.add('fa-award');
                currentBadgeName = 'Hero Donor';
                badgeDescription = 'Going above and beyond to save lives';
            } else if (donationCount >= 21 && donationCount <= 30) {
                badge.classList.add('badge-platinum');
                badgeIcon.classList.add('fa-star');
                currentBadgeName = 'Platinum Champion';
                badgeDescription = 'Exceptional commitment to saving lives';
            } else if (donationCount >= 31 && donationCount <= 39) {
                badge.classList.add('badge-diamond');
                badgeIcon.classList.add('fa-gem');
                currentBadgeName = 'Diamond Guardian';
                badgeDescription = 'A true guardian of life';
            } else if (donationCount >= 40) {
                badge.classList.add('badge-red-diamond');
                badgeIcon.classList.add('fa-crown');
                currentBadgeName = 'Ruby Legacy';
                badgeDescription = 'Leaving a life-saving legacy for generations';
            } else {
                currentBadgeName = 'New Donor';
                badgeDescription = 'Ready to start your life-saving journey';
            }
            
            // Update next badge info
            updateNextBadge(donationCount, currentBadgeName, badgeDescription);
        }
        
        // Update next badge information
        function updateNextBadge(currentDonations, currentBadgeName, badgeDescription) {
            const nextBadgeElement = document.getElementById('nextBadge');
            const nextBadgeText = nextBadgeElement.querySelector('.next-badge-text');
            const nextBadgeIcon = nextBadgeElement.querySelector('i');
            
            // Create a badge info container if it doesn't exist
            let badgeInfoContainer = document.getElementById('badgeInfoContainer');
            if (!badgeInfoContainer) {
                badgeInfoContainer = document.createElement('div');
                badgeInfoContainer.id = 'badgeInfoContainer';
                badgeInfoContainer.className = 'mt-4 p-4 bg-gray-50 rounded-lg';
                nextBadgeElement.parentNode.insertBefore(badgeInfoContainer, nextBadgeElement);
            }
            
            // Display current badge info
            badgeInfoContainer.innerHTML = `
                <div class="text-center mb-3">
                    <div class="text-lg font-bold text-gray-800">${currentBadgeName}</div>
                    <div class="text-sm text-gray-600">${badgeDescription}</div>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <i class="fas fa-tint text-red-500 mr-2"></i>
                        <span class="font-medium">Total Donations:</span>
                    </div>
                    <span class="font-bold">${currentDonations}</span>
                </div>
            `;
            
            // Update next badge info
            if (currentDonations < 1) {
                nextBadgeText.textContent = 'Next badge: First Responder (1 donation)';
                nextBadgeIcon.className = 'fas fa-hand-holding-heart text-gray-400';
            } else if (currentDonations < 4) {
                nextBadgeText.textContent = 'Next badge: Life Saver (4 donations)';
                nextBadgeIcon.className = 'fas fa-heart text-gray-400';
            } else if (currentDonations < 16) {
                nextBadgeText.textContent = 'Next badge: Hero Donor (16 donations)';
                nextBadgeIcon.className = 'fas fa-award text-gray-400';
            } else if (currentDonations < 21) {
                nextBadgeText.textContent = 'Next badge: Platinum Champion (21 donations)';
                nextBadgeIcon.className = 'fas fa-star text-gray-400';
            } else if (currentDonations < 31) {
                nextBadgeText.textContent = 'Next badge: Diamond Guardian (31 donations)';
                nextBadgeIcon.className = 'fas fa-gem text-blue-300';
            } else if (currentDonations < 40) {
                nextBadgeText.textContent = 'Next badge: Ruby Legacy (40 donations)';
                nextBadgeIcon.className = 'fas fa-crown text-red-300';
            } else {
                nextBadgeText.textContent = 'Maximum badge achieved!';
                nextBadgeIcon.className = 'fas fa-star text-yellow-400';
            }
        }
        
        // Setup star rating
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            const giveRatingBtn = document.getElementById('giveRatingBtn');
            
            // Initialize stars
            stars.forEach(function(star) {
                star.addEventListener('mouseover', function() {
                    if (userRating) return; // User has already rated
                    
                    const rating = parseInt(star.getAttribute('data-rating'));
                    highlightStars(rating);
                });
                
                star.addEventListener('click', function() {
                    if (userRating) return; // User has already rated
                    
                    const rating = parseInt(star.getAttribute('data-rating'));
                    selectedRating = rating;
                    highlightStars(rating);
                    giveRatingBtn.classList.add('show');
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                if (userRating) {
                    highlightStars(userRating);
                } else {
                    highlightStars(selectedRating);
                }
            });
            
            // Give rating button click
            giveRatingBtn.addEventListener('click', async function() {
                if (selectedRating === 0) return;
                
                await submitRating(selectedRating);
                giveRatingBtn.classList.remove('show');
            });
        }
        
        // Highlight stars based on rating
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach(function(star, index) {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Submit rating
        async function submitRating(rating) {
            try {
                // Show loading
                document.getElementById('loading').style.display = 'flex';
                
                // Record user rating
                const { error } = await supabase
                    .from('user_ratings')
                    .insert({
                        user_id: currentUser.id,
                        target_donor_id: donorData.id,
                        rating: rating
                    });
                
                if (error) throw error;
                
                userRating = rating;
                selectedRating = 0;
                highlightStars(rating);
                
                // Update average rating display
                await loadAverageRating();
                
                showSuccessToast('Thank you for your rating!');
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Error submitting rating: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Check if user has already rated
        async function checkUserRating() {
            if (!currentUser || !donorData) {
                console.log("Missing current user or donor data");
                return;
            }
            
            try {
                console.log("Checking if user", currentUser.id, "has rated donor", donorData.id);
                
                const { data, error } = await supabase
                    .from('user_ratings')
                    .select('rating')
                    .eq('user_id', currentUser.id)
                    .eq('target_donor_id', donorData.id)
                    .single();
                    
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                    console.error('Error checking user rating:', error);
                    return;
                }
                
                if (data) {
                    userRating = data.rating;
                    console.log("User has already rated with:", userRating);
                    highlightStars(userRating);
                } else {
                    console.log("User has not rated this donor yet");
                }
            } catch (error) {
                console.error('Exception in checkUserRating:', error);
            }
        }
        
        // Load average rating and total star count
        async function loadAverageRating() {
            if (!donorData) {
                console.log("Missing donor data");
                return;
            }
            
            try {
                // Get all ratings for this donor
                const { data, error } = await supabase
                    .from('user_ratings')
                    .select('rating')
                    .eq('target_donor_id', donorData.id);
                
                if (error) throw error;
                
                console.log("All ratings data:", data);
                
                if (data && data.length > 0) {
                    // Calculate average
                    const sum = data.reduce(function(acc, curr) {
                        return acc + curr.rating;
                    }, 0);
                    const average = sum / data.length;
                    
                    console.log("Rating sum:", sum, "Count:", data.length, "Average:", average);
                    
                    // Update UI
                    document.getElementById('averageRating').textContent = average.toFixed(1);
                    document.getElementById('ratingCount').textContent = data.length + ' ratings';
                    document.getElementById('totalStarCount').textContent = 'Total stars: ' + sum;
                    
                    // Only highlight stars if the current user has rated
                    if (currentUser && userRating) {
                        highlightStars(userRating);
                    } else {
                        // For visitors or users who haven't rated, don't highlight any stars
                        // Just show the average rating as a number without highlighting stars
                        const stars = document.querySelectorAll('.star');
                        stars.forEach(function(star) {
                            star.classList.remove('active');
                        });
                    }
                } else {
                    // No ratings yet
                    console.log("No ratings found for this donor");
                    document.getElementById('averageRating').textContent = '0.0';
                    document.getElementById('ratingCount').textContent = '0 ratings';
                    document.getElementById('totalStarCount').textContent = 'Total stars: 0';
                    
                    // Clear any highlighted stars
                    const stars = document.querySelectorAll('.star');
                    stars.forEach(function(star) {
                        star.classList.remove('active');
                    });
                }
            } catch (error) {
                console.error('Error loading average rating:', error);
            }
        }
        
        // Authentication Modal functionality
        const authModal = document.getElementById('authModal');
        const modalLoginBtn = document.getElementById('modalLoginBtn');
        const modalRegisterBtn = document.getElementById('modalRegisterBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        
        // Function to show authentication modal
        function showAuthModal() {
            authModal.classList.remove('hidden');
        }
        
        // Function to hide authentication modal
        function hideAuthModal() {
            authModal.classList.add('hidden');
        }
        
        // Set up modal button event listeners
        modalLoginBtn.addEventListener('click', function() {
            window.location.href = 'userlogin.html';
        });
        
        modalRegisterBtn.addEventListener('click', function() {
            window.location.href = 'registerfrom.html';
        });
        
        modalCancelBtn.addEventListener('click', function() {
            hideAuthModal();
        });
        
        // Close modal when clicking outside
        authModal.addEventListener('click', function(e) {
            if (e.target === authModal) {
                hideAuthModal();
            }
        });
        
        // Load locations from database
        async function loadLocations() {
            try {
                const { data, error } = await supabase
                    .from('locations')
                    .select('*')
                    .order('division', { ascending: true })
                    .order('district', { ascending: true })
                    .order('city', { ascending: true });
                
                if (error) throw error;
                
                locations = data;
                
                // Populate division dropdown
                const divisions = [...new Set(data.map(loc => loc.division))];
                const divisionSelect = document.getElementById('divisionInput');
                
                divisionSelect.innerHTML = '<option value="">Select Division</option>';
                divisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division;
                    option.textContent = division;
                    divisionSelect.appendChild(option);
                });
                
                // Set current values if available
                if (donorData.division) {
                    divisionSelect.value = donorData.division;
                    // Use donorData.state for district (since that's how it's stored in the database)
                    updateDistrictDropdown(donorData.division, donorData.state || donorData.district);
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Update district dropdown based on selected division
        function updateDistrictDropdown(division, selectedDistrict = '') {
            const districtSelect = document.getElementById('districtInput');
            
            // Filter districts by selected division
            const districts = [...new Set(
                locations
                    .filter(loc => loc.division === division)
                    .map(loc => loc.district)
            )];
            
            districtSelect.innerHTML = '<option value="">Select District</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                if (district === selectedDistrict) {
                    option.selected = true;
                }
                districtSelect.appendChild(option);
            });
            
            // Trigger change event to update city dropdown
            if (selectedDistrict) {
                updateCityDropdown(division, selectedDistrict, donorData.city);
            } else {
                // Clear city dropdown
                const citySelect = document.getElementById('cityInput');
                citySelect.innerHTML = '<option value="">Select City</option>';
            }
        }
        
        // Update city dropdown based on selected division and district
        function updateCityDropdown(division, district, selectedCity = '') {
            const citySelect = document.getElementById('cityInput');
            
            // Filter cities by selected division and district
            const cities = locations
                .filter(loc => loc.division === division && loc.district === district)
                .map(loc => loc.city);
            
            citySelect.innerHTML = '<option value="">Select City</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === selectedCity) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });
        }
        
        // Setup location dropdown change events
        function setupLocationDropdowns() {
            const divisionSelect = document.getElementById('divisionInput');
            const districtSelect = document.getElementById('districtInput');
            
            divisionSelect.addEventListener('change', function() {
                const selectedDivision = this.value;
                updateDistrictDropdown(selectedDivision);
            });
            
            districtSelect.addEventListener('change', function() {
                const selectedDivision = divisionSelect.value;
                const selectedDistrict = this.value;
                updateCityDropdown(selectedDivision, selectedDistrict);
            });
        }
        
        // Load user roles
        async function loadUserRoles() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                userRoles = data.map(item => item.role);
                console.log("User roles:", userRoles);
                
                // Check if user has admin or moderator role
                if (userRoles.includes('admin') || userRoles.includes('moderator')) {
                    document.getElementById('adminPanelBtn').classList.remove('hidden');
                    
                    // Show role badge
                    const roleBadge = document.getElementById('roleBadge');
                    roleBadge.classList.remove('hidden');
                    
                    if (userRoles.includes('admin')) {
                        roleBadge.className = 'badge badge-admin';
                        roleBadge.innerHTML = '<i class="fas fa-user-shield mr-2"></i> Admin';
                    } else if (userRoles.includes('moderator')) {
                        roleBadge.className = 'badge badge-moderator';
                        roleBadge.innerHTML = '<i class="fas fa-user-check mr-2"></i> Moderator';
                    }
                }
            } catch (error) {
                console.error('Error loading user roles:', error);
            }
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication using getSession instead of getUser
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError) {
                console.error('Session error:', sessionError);
                showAuthModal();
                return;
            }
            
            if (session && session.user) {
                currentUser = session.user;
                console.log('Current user:', currentUser);
                
                // Load the donor profile
                await loadDonorProfile();
                
                // Load user roles
                await loadUserRoles();
                
                // Load locations for dropdowns
                await loadLocations();
                
                // Setup location dropdowns
                setupLocationDropdowns();
                
                // Setup star rating
                setupStarRating();
                
                // Load average rating first (this will show the average of all ratings)
                await loadAverageRating();
                
                // Then check if current user has already rated (this will override the display if they have)
                await checkUserRating();
                
                // Setup donation history
                setupDonationHistory();
                
                // Setup share button
                setupShareButton();
                
                // Setup photo upload
                setupPhotoUpload();
                
                // Setup admin panel button
                setupAdminPanelButton();
                
                // Setup confirmation modal
                setupConfirmationModal();
            } else {
                // Show authentication modal
                showAuthModal();
            }
            
            // Hide loading spinner
            document.getElementById('loading').style.display = 'none';
        });
        
        // Authentication check using getSession
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Auth error:', error);
                    return null;
                }
                
                return session ? session.user : null;
            } catch (error) {
                console.error('Exception during auth check:', error);
                return null;
            }
        }
        
        // Load donor profile
        async function loadDonorProfile() {
            try {
                console.log('Loading donor profile for user ID:', currentUser.id);
                
                // Load donor data
                const { data, error } = await supabase
                    .from('donors')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                    
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                if (!data) {
                    console.error('No donor data found for user ID:', currentUser.id);
                    throw new Error('Donor profile not found');
                }
                
                console.log('Donor data loaded:', data);
                
                donorData = data;
                updateUI();
            } catch (error) {
                console.error('Error loading donor data:', error);
                alert('Error loading profile data: ' + error.message);
                window.location.href = 'userlogin.html';
            }
        }
        
        // Update UI with donor data
        function updateUI() {
            // Profile info
            const userNameElement = document.getElementById('userName');
            if (userNameElement) userNameElement.textContent = donorData.name;
            
            const bloodGroupElement = document.getElementById('bloodGroup');
            if (bloodGroupElement) bloodGroupElement.innerHTML = '<i class="fas fa-tint mr-1"></i> ' + donorData.blood_group;
            
            const userAgeElement = document.getElementById('userAge');
            if (userAgeElement) userAgeElement.innerHTML = '<i class="fas fa-user mr-1"></i> ' + donorData.age + ' years';
            
            if (donorData.avatar_url) {
                document.getElementById('profilePhoto').src = donorData.avatar_url;
            } else {
                // Use a default avatar with donor's initials
                const initials = donorData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('profilePhoto').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=c62828&color=fff&size=200`;
            }
            
            // Update donation badge
            updateDonationBadge(donorData.times_donated || 0);
            
            // Donation stats
            document.getElementById('totalDonations').textContent = donorData.times_donated || 0;
            
            if (donorData.last_donation) {
                const lastDonationDate = new Date(donorData.last_donation);
                const daysSinceLastDonation = Math.floor((new Date() - lastDonationDate) / (1000 * 60 * 60 * 24));
                document.getElementById('lastDonation').textContent = daysSinceLastDonation + ' days ago';
                
                // Calculate progress
                const daysRemaining = Math.max(0, 90 - daysSinceLastDonation);
                const progressPercent = Math.min(100, Math.floor((daysSinceLastDonation / 90) * 100));
                
                updateProgressCircle(progressPercent);
                
                if (daysRemaining > 0) {
                    document.getElementById('nextDonationText').innerHTML = 
                        'You will be eligible to donate in <span class="font-bold text-red-500">' + daysRemaining + ' days</span>';
                } else {
                    document.getElementById('nextDonationText').textContent = 'You are eligible to donate now!';
                }
            } else {
                document.getElementById('lastDonation').textContent = 'Never';
                document.getElementById('nextDonationText').textContent = 'No donation history available';
                updateProgressCircle(0);
            }
            
            // User info - Check if elements exist before setting values
            const phoneInput = document.getElementById('phoneInput');
            if (phoneInput) phoneInput.value = donorData.phone || 'Not provided';
            
            // Email field
            const emailInput = document.getElementById('emailInput');
            if (emailInput && currentUser && currentUser.email) {
                emailInput.value = currentUser.email;
            }
            
            // Location info - Set current values
            const divisionInput = document.getElementById('divisionInput');
            const districtInput = document.getElementById('districtInput');
            const cityInput = document.getElementById('cityInput');
            
            if (divisionInput) divisionInput.value = donorData.division || 'Not provided';
            if (districtInput) districtInput.value = donorData.state || donorData.district || 'Not provided'; // Using state field for district
            if (cityInput) cityInput.value = donorData.city || 'Not provided';
            
            const customIdInput = document.getElementById('customIdInput');
            if (customIdInput) customIdInput.value = donorData.custom_id || donorData.id.toString().substring(0, 8);
        }
        
        // Update progress circle
        function updateProgressCircle(percent) {
            const circle = document.getElementById('progressCircle');
            const radius = 86;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = percent + '%';
        }
        
        // Setup donation history
        function setupDonationHistory() {
            const donationHistoryBtn = document.getElementById('donationHistoryBtn');
            const donationHistoryModal = document.getElementById('donationHistoryModal');
            const closeDonationHistoryBtn = document.getElementById('closeDonationHistoryBtn');
            
            donationHistoryBtn.addEventListener('click', async function() {
                // Show loading
                document.getElementById('loading').style.display = 'flex';
                
                try {
                    // First, let's check if we have the donor data
                    console.log("Donor data:", donorData);
                    console.log("Donor ID:", donorData.id);
                    console.log("Donor user_id:", donorData.user_id);
                    
                    // We need to use the user_id field from donorData to query donation_updates
                    // If donorData doesn't have user_id, we need to get it from the donors table
                    let userId = donorData.user_id;
                    
                    if (!userId) {
                        console.log("No user_id in donorData, fetching from donors table");
                        const { data: donor, error: donorError } = await supabase
                            .from('donors')
                            .select('user_id')
                            .eq('id', donorData.id)
                            .single();
                        
                        if (donorError) {
                            console.error('Error fetching user_id:', donorError);
                            throw donorError;
                        }
                        
                        userId = donor.user_id;
                        console.log("Retrieved user_id:", userId);
                    }
                    
                    let data = [];
                    
                    if (!userId) {
                        console.log("No user_id found for this donor");
                        // Continue with empty data instead of throwing an error
                    } else {
                        // Fetch donation history using the user_id
                        console.log("Fetching donation history with user_id:", userId);
                        const { data: donationData, error } = await supabase
                            .from('donation_updates')
                            .select('*')
                            .eq('user_id', userId)
                            .order('donation_date', { ascending: false });
                        
                        console.log("Query result:", { data: donationData, error });
                        
                        if (error) {
                            console.error('Error fetching donation history:', error);
                            throw error;
                        }
                        
                        data = donationData;
                    }
                    
                    // Check if we got any data
                    console.log("Data length:", data ? data.length : "null");
                    
                    // Populate donation history table
                    const donationHistoryList = document.getElementById('donationHistoryList');
                    const noDonationHistory = document.getElementById('noDonationHistory');
                    
                    if (data && data.length > 0) {
                        console.log("Populating donation history table...");
                        donationHistoryList.innerHTML = data.map(function(donation) {
                            console.log("Processing donation:", donation);
                            return '<tr>' +
                                '<td>' + (donation.donation_date ? new Date(donation.donation_date).toLocaleDateString() : 'N/A') + '</td>' +
                                '<td>' + (donation.place || 'N/A') + '</td>' +
                                '<td><span class="badge badge-blood">' + (donation.blood_group || 'N/A') + '</span></td>' +
                                '<td>#' + (donation.times_donated || 'N/A') + '</td>' +
                            '</tr>';
                        }).join('');
                        donationHistoryList.classList.remove('hidden');
                        noDonationHistory.classList.add('hidden');
                        console.log("Donation history populated");
                    } else {
                        console.log("No donation history found");
                        donationHistoryList.innerHTML = '';
                        donationHistoryList.classList.add('hidden');
                        noDonationHistory.classList.remove('hidden');
                    }
                    
                    // Show modal
                    donationHistoryModal.classList.remove('hidden');
                    console.log("Modal should be visible now");
                } catch (error) {
                    console.error('Error loading donation history:', error);
                    alert('Error loading donation history: ' + error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            closeDonationHistoryBtn.addEventListener('click', function() {
                donationHistoryModal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            donationHistoryModal.addEventListener('click', function(e) {
                if (e.target === donationHistoryModal) {
                    donationHistoryModal.classList.add('hidden');
                }
            });
        }
        
        // Setup share button
        function setupShareButton() {
            document.getElementById('shareBtn').addEventListener('click', function() {
                if (navigator.share) {
                    navigator.share({
                        title: donorData.name + ' - Blood Donor Profile',
                        text: 'Check out ' + donorData.name + "'s blood donor profile on Look4Blood",
                        url: window.location.href
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const dummy = document.createElement('input');
                    document.body.appendChild(dummy);
                    dummy.value = window.location.href;
                    dummy.select();
                    document.execCommand('copy');
                    document.body.removeChild(dummy);
                    showSuccessToast('Profile link copied to clipboard!');
                }
            });
        }
        
        // Setup photo upload
        function setupPhotoUpload() {
            const profilePhoto = document.getElementById('profilePhoto');
            const photoUpload = document.getElementById('photoUpload');
            const uploadOverlay = document.querySelector('.upload-overlay');
            
            // Click on overlay or photo to trigger file input
            uploadOverlay.addEventListener('click', () => {
                photoUpload.click();
            });
            
            profilePhoto.addEventListener('click', () => {
                photoUpload.click();
            });
            
            // Handle file selection
            photoUpload.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        // Show crop modal
                        document.getElementById('cropImage').src = event.target.result;
                        document.getElementById('cropModal').classList.remove('hidden');
                        
                        // Initialize cropper
                        setTimeout(() => {
                            if (cropper) {
                                cropper.destroy();
                            }
                            
                            const image = document.getElementById('cropImage');
                            cropper = new Cropper(image, {
                                aspectRatio: 1,
                                viewMode: 2,
                                autoCropArea: 0.8,
                                responsive: true,
                                checkCrossOrigin: false
                            });
                        }, 100);
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Cancel crop
            document.getElementById('cancelCropBtn').addEventListener('click', () => {
                document.getElementById('cropModal').classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });
            
            // Apply crop
            document.getElementById('applyCropBtn').addEventListener('click', async () => {
                if (cropper) {
                    // Get cropped canvas
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300,
                        minWidth: 256,
                        minHeight: 256,
                        maxWidth: 4096,
                        maxHeight: 4096,
                        fillColor: '#fff',
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    });
                    
                    // Convert to blob
                    canvas.toBlob(async (blob) => {
                        try {
                            // Show loading
                            document.getElementById('loading').style.display = 'flex';
                            
                            // Generate unique filename
                            const fileName = `profile-${currentUser.id}-${Date.now()}.jpg`;
                            
                            // Check if bucket exists first
                            const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
                            
                            if (bucketError) {
                                console.error('Error checking buckets:', bucketError);
                                throw bucketError;
                            }
                            
                            const avatarBucket = buckets.find(b => b.name === 'avatars');
                            
                            if (!avatarBucket) {
                                throw new Error('Storage bucket "avatars" not found. Please create it in your Supabase dashboard.');
                            }
                            
                            // Upload to Supabase Storage
                            const { data, error } = await supabase.storage
                                .from('avatars')
                                .upload(fileName, blob, {
                                    contentType: 'image/jpeg',
                                    upsert: false
                                });
                            
                            if (error) {
                                console.error('Upload error:', error);
                                if (error.message.includes('bucket not found') || error.statusCode === 404) {
                                    throw new Error('Storage bucket "avatars" not found. Please create it in your Supabase dashboard.');
                                } else {
                                    throw error;
                                }
                            }
                            
                            // Get public URL
                            const { data: publicUrlData } = supabase.storage
                                .from('avatars')
                                .getPublicUrl(fileName);
                            
                            const avatarUrl = publicUrlData.publicUrl;
                            
                            // Update donor record
                            const { error: updateError } = await supabase
                                .from('donors')
                                .update({ avatar_url: avatarUrl })
                                .eq('id', donorData.id);
                            
                            if (updateError) throw updateError;
                            
                            // Update UI
                            document.getElementById('profilePhoto').src = avatarUrl;
                            donorData.avatar_url = avatarUrl;
                            
                            // Close modal and destroy cropper
                            document.getElementById('cropModal').classList.add('hidden');
                            cropper.destroy();
                            cropper = null;
                            
                            showSuccessToast('Profile picture updated successfully!');
                        } catch (error) {
                            console.error('Error uploading profile picture:', error);
                            
                            if (error.message.includes('Storage bucket "avatars" not found')) {
                                alert('Error: The storage bucket for avatars has not been created. Please contact your administrator or create it in the Supabase dashboard.');
                            } else {
                                alert('Error uploading profile picture: ' + error.message);
                            }
                        } finally {
                            document.getElementById('loading').style.display = 'none';
                        }
                    }, 'image/jpeg', 0.9);
                }
            });
        }
        
        // Setup admin panel button
        function setupAdminPanelButton() {
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            
            adminPanelBtn.addEventListener('click', function() {
                window.location.href = 'admin.html';
            });
        }
        
        // Setup confirmation modal
        function setupConfirmationModal() {
            const confirmSaveBtn = document.getElementById('confirmSaveBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            
            confirmSaveBtn.addEventListener('click', async function() {
                // Hide confirmation modal
                document.getElementById('confirmModal').classList.add('hidden');
                
                try {
                    // Validate fields
                    const name = document.getElementById('nameInput').value.trim();
                    const age = parseInt(document.getElementById('ageInput').value);
                    const phone = document.getElementById('phoneInput').value.trim();
                    const division = document.getElementById('divisionInput').value;
                    const district = document.getElementById('districtInput').value;
                    const city = document.getElementById('cityInput').value;
                    
                    if (!name) {
                        alert('Please enter your name');
                        return;
                    }
                    
                    if (!age || age < 18 || age > 65) {
                        alert('Please enter a valid age between 18 and 65');
                        return;
                    }
                    
                    if (!phone) {
                        alert('Please enter your phone number');
                        return;
                    }
                    
                    // Validate phone number (11 digits)
                    if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                        alert('Please enter a valid 11-digit phone number');
                        return;
                    }
                    
                    if (!division || !district || !city) {
                        alert('Please select your division, district, and city');
                        return;
                    }
                    
                    const updateData = {
                        name: name,
                        age: age,
                        phone: phone,
                        division: division,
                        state: district,  // Using 'state' field for district
                        city: city
                    };
                    
                    // Show loading
                    document.getElementById('loading').style.display = 'flex';
                    
                    const { error } = await supabase
                        .from('donors')
                        .update(updateData)
                        .eq('id', donorData.id);
                    
                    if (error) throw error;
                    
                    // Update local data
                    donorData = { ...donorData, ...updateData };
                    
                    // Exit edit mode
                    isEditMode = false;
                    document.getElementById('editBtn').classList.remove('hidden');
                    document.getElementById('saveBtn').classList.add('hidden');
                    
                    // Disable fields
                    document.getElementById('phoneInput').disabled = true;
                    document.getElementById('divisionInput').disabled = true;
                    document.getElementById('districtInput').disabled = true;
                    document.getElementById('cityInput').disabled = true;
                    
                    // Restore background
                    document.getElementById('phoneInput').classList.add('bg-gray-100');
                    
                    // Show success message
                    showSuccessToast('Profile updated successfully!');
                    
                    // Reload all data automatically
                    await loadDonorProfile();
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('Error updating profile: ' + error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            confirmCancelBtn.addEventListener('click', function() {
                // Hide confirmation modal
                document.getElementById('confirmModal').classList.add('hidden');
                
                // Cancel all changes by restoring original data
                restoreOriginalData();
            });
        }
        
        // Function to restore original data when canceling changes
        function restoreOriginalData() {
            // Exit edit mode
            isEditMode = false;
            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            
            // Disable fields
            document.getElementById('phoneInput').disabled = true;
            document.getElementById('divisionInput').disabled = true;
            document.getElementById('districtInput').disabled = true;
            document.getElementById('cityInput').disabled = true;
            
            // Restore background
            document.getElementById('phoneInput').classList.add('bg-gray-100');
            
            // Restore original values
            if (originalProfileData.name) {
                donorData.name = originalProfileData.name;
            }
            if (originalProfileData.age) {
                donorData.age = originalProfileData.age;
            }
            if (originalProfileData.phone) {
                donorData.phone = originalProfileData.phone;
            }
            if (originalProfileData.division) {
                donorData.division = originalProfileData.division;
            }
            if (originalProfileData.state) {
                donorData.state = originalProfileData.state;
            }
            if (originalProfileData.city) {
                donorData.city = originalProfileData.city;
            }
            
            // Update UI with original values
            updateUI();
        }
        
        // Comment functionality
        document.getElementById('commentBtn').addEventListener('click', function() {
            const section = document.getElementById('commentsSection');
            section.classList.toggle('open');
            
            if (section.classList.contains('open')) {
                loadComments();
            }
        });
        
        // Load comments
        async function loadComments() {
            try {
                // First get all comments
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('*')
                    .eq('target_donor_id', donorData.id)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                const commentsList = document.getElementById('commentsList');
                
                if (comments && comments.length > 0) {
                    // Get all unique commenter IDs
                    const commenterIds = [...new Set(comments.map(comment => comment.user_id))];
                    
                    // Fetch commenter information from donors table
                    const { data: donors, error: donorError } = await supabase
                        .from('donors')
                        .select('id, name, avatar_url, user_id')
                        .in('user_id', commenterIds);
                    
                    if (donorError) {
                        console.error('Error fetching donor info:', donorError);
                        // Fallback to showing comments without donor info
                        commentsList.innerHTML = comments.map(function(comment) {
                            return '<div class="flex space-x-3 p-4 bg-gray-50 rounded-lg">' +
                                '<img src="https://picsum.photos/seed/default/40/40.jpg" alt="User" class="w-12 h-12 rounded-full object-cover">' +
                                '<div class="flex-1">' +
                                    '<p class="font-semibold text-gray-800">Anonymous</p>' +
                                    '<p class="text-gray-700 mt-1">' + comment.content + '</p>' +
                                    '<p class="text-xs text-gray-500 mt-2">' +
                                        '<i class="fas fa-clock mr-1"></i>' +
                                        new Date(comment.created_at).toLocaleDateString() +
                                    '</p>' +
                                '</div>' +
                            '</div>';
                        }).join('');
                        return;
                    }
                    
                    // Create a map for quick lookup
                    const donorMap = {};
                    donors.forEach(donor => {
                        donorMap[donor.user_id] = donor;
                    });
                    
                    // Render comments with donor info
                    commentsList.innerHTML = comments.map(function(comment) {
                        const donor = donorMap[comment.user_id];
                        const name = donor?.name || 'Anonymous';
                        const avatar = donor?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=c62828&color=fff&size=40`;
                        const date = new Date(comment.created_at);
                        const formattedDate = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        return '<div class="flex space-x-3 p-4 bg-gray-50 rounded-lg">' +
                            '<img src="' + avatar + '" alt="' + name + '" class="w-12 h-12 rounded-full object-cover">' +
                            '<div class="flex-1">' +
                                '<p class="font-semibold text-gray-800">' + name + '</p>' +
                                '<p class="text-gray-700 mt-1">' + comment.content + '</p>' +
                                '<p class="text-xs text-gray-500 mt-2">' +
                                    '<i class="fas fa-clock mr-1"></i>' +
                                    formattedDate +
                                '</p>' +
                            '</div>' +
                        '</div>';
                    }).join('');
                } else {
                    commentsList.innerHTML = 
                        '<div class="text-center py-8 text-gray-500">' +
                            '<i class="fas fa-comments text-4xl mb-3"></i>' +
                            '<p>No comments yet. Be the first to comment!</p>' +
                        '</div>';
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }
        
        // Add comment
        document.getElementById('addCommentBtn').addEventListener('click', async function() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                // Show loading
                document.getElementById('loading').style.display = 'flex';
                
                const { error } = await supabase
                    .from('comments')
                    .insert({
                        user_id: currentUser.id,
                        target_donor_id: donorData.id,
                        content: content
                    });
                    
                if (error) throw error;
                
                input.value = '';
                loadComments();
                showSuccessToast('Comment added successfully!');
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
        
        // Report functionality
        document.getElementById('reportBtn').addEventListener('click', function() {
            document.getElementById('reportModal').classList.remove('hidden');
        });
        
        document.getElementById('cancelReportBtn').addEventListener('click', function() {
            document.getElementById('reportModal').classList.add('hidden');
        });
        
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!reason) {
                alert('Please select a reason');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('reports')
                    .insert({
                        reporter_id: currentUser.id,
                        reported_donor_id: donorData.id,
                        reason: reason,
                        description: description
                    });
                    
                if (error) throw error;
                
                showSuccessToast('Report submitted successfully');
                document.getElementById('reportModal').classList.add('hidden');
                document.getElementById('reportForm').reset();
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Error submitting report');
            }
        });
        
        // Edit/Save functionality
        document.getElementById('editBtn').addEventListener('click', function() {
            isEditMode = true;
            
            // Store original data for potential cancel operation
            originalProfileData = {
                name: donorData.name,
                age: donorData.age,
                phone: donorData.phone,
                division: donorData.division,
                state: donorData.state || donorData.district,
                city: donorData.city
            };
            
            document.getElementById('editBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            
            // Enable editable fields
            const phoneInput = document.getElementById('phoneInput');
            phoneInput.disabled = false;
            phoneInput.classList.remove('bg-gray-100');
            
            document.getElementById('divisionInput').disabled = false;
            document.getElementById('districtInput').disabled = false;
            document.getElementById('cityInput').disabled = false;
            
            // Make name and age editable
            const userNameElement = document.getElementById('userName');
            const userAgeElement = document.getElementById('userAge');
            
            // Convert name to input field
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = userNameElement.textContent;
            nameInput.className = 'form-input text-3xl md:text-4xl font-bold text-gray-800 mb-3';
            nameInput.id = 'nameInput';
            if (userNameElement.parentNode) {
                userNameElement.parentNode.replaceChild(nameInput, userNameElement);
            }
            
            // Convert age to input field
            const ageInput = document.createElement('input');
            ageInput.type = 'number';
            ageInput.min = '18';
            ageInput.max = '65';
            ageInput.value = donorData.age;
            ageInput.className = 'form-input';
            ageInput.id = 'ageInput';
            
            // Replace the age badge with input
            const ageBadge = document.getElementById('userAge');
            if (ageBadge && ageBadge.parentNode) {
                const ageContainer = ageBadge.parentNode;
                ageContainer.innerHTML = '';
                ageContainer.appendChild(ageInput);
            }
        });
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            // Show confirmation modal
            document.getElementById('confirmModal').classList.remove('hidden');
        });
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                // Show loading
                document.getElementById('loading').style.display = 'flex';
                
                // Clear any local storage or session data
                localStorage.clear();
                sessionStorage.clear();
                
                // Sign out from Supabase
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out');
                } else {
                    // Redirect to login page
                    window.location.href = 'userlogin.html';
                }
            } catch (error) {
                console.error('Exception during logout:', error);
                alert('Error during logout');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>

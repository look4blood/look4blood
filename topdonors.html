<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donor Rankings & Filters</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* [All styles kept unchanged from your original] */
    /* ... your CSS here (unchanged for brevity) ... */
  </style>
</head>
<body>

<header>
  <h1>Donor Rankings & Filters</h1>
  <div id="total-donors">Total Donors: 0</div>
</header>

<!-- Filters -->
<div id="filters" style="flex-wrap:wrap; justify-content:center;">
  <button data-filter="all" class="active">All</button>
  <button data-filter="top3">Top 3</button>
  <button data-filter="bronze">Bronze</button>
  <button data-filter="silver">Silver</button>
  <button data-filter="gold">Gold</button>
  <button data-filter="platinum">Platinum</button>
  <button data-filter="diamond">Diamond</button>
  <select id="bloodGroupFilter" aria-label="Select Blood Group">
    <option value="all">All Blood Groups</option>
  </select>
  <select id="cityFilter" aria-label="Select City">
    <option value="all">All Cities</option>
  </select>
  <select id="badgeFilter" aria-label="Select Badge">
    <option value="all">All Badges</option>
    <option value="bronze">Bronze</option>
    <option value="silver">Silver</option>
    <option value="gold">Gold</option>
    <option value="platinum">Platinum</option>
    <option value="diamond">Diamond</option>
  </select>
</div>

<!-- Donors list -->
<div id="donors-section">
  <div id="donors-header">Donor List</div>
  <div id="donors-container"></div>
</div>

<!-- Badge Ranks -->
<h3 style="text-align:center; margin-top:40px; color:#d32f2f;">Badge Ranks & Symbols</h3>
<div id="rank-badges">
  <div class="rank-badge"><div class="rank-icon">ðŸ¥‰</div><div>Bronze (1-3)</div></div>
  <div class="rank-badge"><div class="rank-icon">ðŸ¥ˆ</div><div>Silver (4-15)</div></div>
  <div class="rank-badge"><div class="rank-icon">ðŸ¥‡</div><div>Gold (16-20)</div></div>
  <div class="rank-badge"><div class="rank-icon">ðŸ’ </div><div>Platinum (21-30)</div></div>
  <div class="rank-badge"><div class="rank-icon">ðŸ’Ž</div><div>Diamond (31+)</div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabaseUrl = 'https://bbvyjeljeyofswuijlyg.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);
  const tableName = 'donors'; // change to exact table name if needed

  let donors = [];

  async function fetchDonors() {
    try {
      const { data, error } = await supabase.from(tableName).select('*');
      if (error) {
        console.error('Supabase fetch error:', error);
        alert('Could not load donor data. Check console for error.');
        return;
      }
      donors = data || [];
      processDonors();
    } catch (e) {
      console.error('Unexpected error:', e);
      alert('Unexpected error occurred.');
    }
  }

  function processDonors() {
    donors.sort((a, b) => (b.times_donated || 0) - (a.times_donated || 0));
    donors.forEach((d, i) => d.rank = i + 1);
    populateFilters();
    renderDonors(donors);
  }

  function getBadge(donations = 0) {
    if (donations <= 3) return { label: 'Bronze', class: 'badge-bronze', symbol: 'ðŸ¥‰' };
    if (donations <= 15) return { label: 'Silver', class: 'badge-silver', symbol: 'ðŸ¥ˆ' };
    if (donations <= 20) return { label: 'Gold', class: 'badge-golden', symbol: 'ðŸ¥‡' };
    if (donations <= 30) return { label: 'Platinum', class: 'badge-platinum', symbol: 'ðŸ’ ' };
    return { label: 'Diamond', class: 'badge-diamond', symbol: 'ðŸ’Ž' };
  }

  function createDonorHTML(d) {
    const badge = getBadge(d.times_donated);
    return `
      <div class="donor-card" data-rank="${d.rank}" data-badge="${badge.label.toLowerCase()}" data-blood="${d.blood_group}" data-city="${d.city}">
        <div class="rank">${d.rank}</div>
        <div class="info">
          <div class="name">${d.name}</div>
          <div class="details">
            <div class="detail"><strong>Blood:</strong> ${d.blood_group}</div>
            <div class="detail"><strong>City:</strong> ${d.city}</div>
            <div class="detail"><strong>Donations:</strong> ${d.times_donated}</div>
            <div class="detail"><strong>Phone:</strong> ${d.phone}</div>
          </div>
          <div class="badge ${badge.class}">
            <span class="badge-symbol">${badge.symbol}</span>
            <span class="badge-label">${badge.label}</span>
          </div>
        </div>
      </div>`;
  }

  function renderDonors(data) {
    const container = document.getElementById('donors-container');
    if (!data.length) {
      container.innerHTML = '<p style="text-align:center;">No donors found.</p>';
    } else {
      container.innerHTML = data.map(createDonorHTML).join('');
    }
    updateTotalDonors(data.length);
  }

  function updateTotalDonors(count) {
    document.getElementById('total-donors').textContent = `Total Donors: ${count}`;
  }

  function populateFilters() {
    const bloodSet = new Set();
    const citySet = new Set();
    donors.forEach(d => {
      if (d.blood_group) bloodSet.add(d.blood_group);
      if (d.city) citySet.add(d.city);
    });

    const bloodSelect = document.getElementById('bloodGroupFilter');
    const citySelect = document.getElementById('cityFilter');
    bloodSelect.innerHTML = '<option value="all">All Blood Groups</option>';
    citySelect.innerHTML = '<option value="all">All Cities</option>';

    [...bloodSet].sort().forEach(bg => {
      const option = document.createElement('option');
      option.value = bg;
      option.textContent = bg;
      bloodSelect.appendChild(option);
    });

    [...citySet].sort().forEach(city => {
      const option = document.createElement('option');
      option.value = city;
      option.textContent = city;
      citySelect.appendChild(option);
    });
  }

  function applyFilters() {
    let filtered = [...donors];

    const activeBtn = document.querySelector('#filters button.active');
    const type = activeBtn?.dataset.filter;

    if (type && type !== 'all') {
      if (type === 'top3') filtered = filtered.slice(0, 3);
      else filtered = filtered.filter(d => getBadge(d.times_donated).label.toLowerCase() === type);
    }

    const bloodVal = document.getElementById('bloodGroupFilter').value;
    const cityVal = document.getElementById('cityFilter').value;
    const badgeVal = document.getElementById('badgeFilter').value;

    if (bloodVal !== 'all') filtered = filtered.filter(d => d.blood_group === bloodVal);
    if (cityVal !== 'all') filtered = filtered.filter(d => d.city === cityVal);
    if (badgeVal !== 'all') filtered = filtered.filter(d => getBadge(d.times_donated).label.toLowerCase() === badgeVal);

    filtered.sort((a, b) => (b.times_donated || 0) - (a.times_donated || 0));
    filtered.forEach((d, i) => d.rank = i + 1);
    renderDonors(filtered);
  }

  document.querySelectorAll('#filters button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#filters button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    });
  });

  document.getElementById('bloodGroupFilter').addEventListener('change', applyFilters);
  document.getElementById('cityFilter').addEventListener('change', applyFilters);
  document.getElementById('badgeFilter').addEventListener('change', applyFilters);

  fetchDonors();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Donor Profile - Look4Blood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        :root {
            --primary-red: #c62828;
            --primary-red-dark: #b71c1c;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #334155;
        }
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(198, 40, 40, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-red);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
        }
        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .like-animation {
            animation: bounce 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Comment Section */
        .comment-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .comment-section.open {
            max-height: 500px;
        }
        /* Cropper styles */
        .cropper-container {
            max-height: 400px;
        }
        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 50%;
            cursor: pointer;
        }
        .profile-photo-container:hover .upload-overlay {
            opacity: 1;
        }
        /* Table styles */
        .donation-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .donation-table th, .donation-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .donation-table th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .donation-table tr:hover {
            background-color: #f8fafc;
        }
        /* Card Styles */
        .profile-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.1), 0 15px 15px -5px rgba(0, 0, 0, 0.04);
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: all 0.3s ease;
            border-top: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-red), #e91e63, #9c27b0);
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(198, 40, 40, 0.4);
        }
        .btn-secondary {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.4);
        }
        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.4);
        }
        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            font-family: inherit;
            color: #334155;
            background: white;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
            transform: translateY(-1px);
        }
        .form-input:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        .form-input:disabled {
            background-color: #f8fafc;
            color: #94a3b8;
            cursor: not-allowed;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-blood {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #b91c1c;
        }
        .badge-age {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
        }
        /* Donation Badge Styles */
        .donation-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .badge-bronze {
            background: linear-gradient(135deg, #cd7f32, #b87333);
        }
        .badge-silver {
            background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
        }
        .badge-gold {
            background: linear-gradient(135deg, #ffd700, #ffcc00);
        }
        .badge-platinum {
            background: linear-gradient(135deg, #e5e4e2, #d3d3d3);
        }
        .badge-diamond {
            background: linear-gradient(135deg, #b9f2ff, #87ceeb);
        }
        .badge-red-diamond {
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
        }
        /* Star Rating Styles */
        .star-rating {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .star {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star:hover,
        .star.active {
            color: #ffc107;
        }
        .rating-info {
            text-align: center;
            margin-top: 0.5rem;
        }
        .rating-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .rating-text {
            color: #666;
            font-size: 0.9rem;
        }
        .total-star-count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .rating-actions {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        .btn-give-rating {
            display: none;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-give-rating:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(255, 193, 7, 0.4);
        }
        .btn-give-rating.show {
            display: inline-flex;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info-grid {
                grid-template-columns: 1fr;
            }
            
            .star {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Profile Header -->
        <div class="profile-card mb-8 p-6 md:p-8 fade-in">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
                <!-- Profile Photo -->
                <div class="profile-photo-container relative">
                    <img id="profilePhoto" src="https://bbvyjeljeyofswuijlyg.supabase.co/storage/v1/object/public/avatars//145856997_296fe121-5dfa-43f4-98b5-db50019738a7%20(2).jpg" 
                         alt="Profile" class="w-40 h-40 rounded-full object-cover border-4 border-white shadow-lg">
                    <div class="upload-overlay">
                        <div class="text-white text-center">
                            <i class="fas fa-camera text-3xl mb-2"></i>
                            <p class="text-sm font-medium">Change Photo</p>
                        </div>
                    </div>
                    <!-- Donation Badge -->
                    <div id="donationBadge" class="donation-badge badge-bronze">
                        <i class="fas fa-medal text-white text-xl"></i>
                    </div>
                    <input type="file" id="photoUpload" class="hidden" accept="image/*">
                </div>
                
                <!-- Basic Info -->
                <div class="flex-1 text-center md:text-left">
                    <h1 id="userName" class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">Loading...</h1>
                    <div class="flex flex-wrap justify-center md:justify-start gap-3 mb-4">
                        <span id="bloodGroup" class="badge badge-blood">
                            <i class="fas fa-tint mr-1"></i> A+
                        </span>
                        <span id="userAge" class="badge badge-age">
                            <i class="fas fa-user mr-1"></i> 27 years
                        </span>
                    </div>
                    <p class="text-gray-600 max-w-2xl">
                        Dedicated blood donor committed to saving lives through regular donations. 
                        Every donation can help save up to three lives.
                    </p>
                </div>
            </div>
        </div>
        <!-- Stats Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Left Side - Donation Stats -->
            <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-chart-line text-red-500 mr-2"></i>Donation History
                    </h2>
                    <button id="donationHistoryBtn" class="btn btn-info">
                        <i class="fas fa-history"></i> View All
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 font-medium">
                            <i class="fas fa-hand-holding-heart text-red-500 mr-2"></i>Total Donations
                        </span>
                        <span id="totalDonations" class="text-3xl font-bold text-red-500">12</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600 font-medium">
                            <i class="fas fa-calendar-check text-green-500 mr-2"></i>Last Donation
                        </span>
                        <span id="lastDonation" class="text-xl font-semibold text-gray-800">25 days ago</span>
                    </div>
                    
                    <!-- Progress Circle -->
                    <div class="flex flex-col items-center mt-8">
                        <div class="relative w-48 h-48">
                            <svg class="progress-ring w-48 h-48">
                                <circle class="text-gray-200" stroke="currentColor" stroke-width="10" 
                                        fill="transparent" r="86" cx="96" cy="96"/>
                                <circle id="progressCircle" class="progress-ring__circle text-red-500" 
                                        stroke="currentColor" stroke-width="10" fill="transparent" 
                                        r="86" cx="96" cy="96"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="progressPercent" class="text-3xl font-bold text-gray-800">25%</span>
                                <span class="text-sm text-gray-500">Progress</span>
                            </div>
                        </div>
                        <p id="nextDonationText" class="mt-6 text-center text-gray-600 font-medium">
                            This donor will be eligible to donate in 
                            <span class="font-bold text-red-500">65 days</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Interactions -->
            <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-users text-blue-500 mr-2"></i>Community Feedback
                </h2>
                
                <!-- Star Rating -->
                <div class="star-rating" id="starRating">
                    <i class="fas fa-star star" data-rating="1"></i>
                    <i class="fas fa-star star" data-rating="2"></i>
                    <i class="fas fa-star star" data-rating="3"></i>
                    <i class="fas fa-star star" data-rating="4"></i>
                    <i class="fas fa-star star" data-rating="5"></i>
                </div>
                
                <div class="rating-actions">
                    <button id="giveRatingBtn" class="btn btn-give-rating">
                        <i class="fas fa-star mr-2"></i> Give Rating
                    </button>
                </div>
                
                <div class="rating-info">
                    <div id="averageRating" class="rating-count">0.0</div>
                    <div id="ratingCount" class="rating-text">0 ratings</div>
                    <div id="totalStarCount" class="total-star-count">Total stars: 0</div>
                </div>
                
                <div class="space-y-3 mt-6">
                    <button id="commentBtn" class="btn btn-primary w-full justify-center">
                        <i class="fas fa-comment"></i> View Comments
                    </button>
                    
                    <button id="reportBtn" class="btn btn-warning w-full justify-center">
                        <i class="fas fa-flag"></i> Report User
                    </button>
                </div>
                
                <!-- Comments Section -->
                <div id="commentsSection" class="comment-section mt-6">
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-comments text-blue-500 mr-2"></i> Comments
                        </h3>
                        <div id="commentsList" class="space-y-4 max-h-60 overflow-y-auto mb-4">
                            <!-- Comments will be loaded here -->
                        </div>
                        <div class="flex space-x-2">
                            <input id="commentInput" type="text" placeholder="Add a comment..." 
                                   class="form-input flex-1">
                            <button id="addCommentBtn" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- User Info Section -->
        <div class="stat-card mb-8 fade-in" style="animation-delay: 0.3s;">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-user-circle text-purple-500 mr-2"></i> User Information
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-phone text-blue-500 mr-1"></i> Phone Number
                        </label>
                        <input id="phoneInput" type="tel" disabled 
                               class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt text-red-500 mr-1"></i> City
                        </label>
                        <input id="cityInput" type="text" disabled 
                               class="form-input">
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-globe text-green-500 mr-1"></i> Division
                        </label>
                        <input id="districtInput" type="text" disabled 
                               class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            <i class="fas fa-id-card text-purple-500 mr-1"></i> User ID
                        </label>
                        <input id="userIdInput" type="text" readonly 
                               class="form-input bg-gray-100">
                    </div>
                </div>
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-8 fade-in" style="animation-delay: 0.4s;">
            <button id="editBtn" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Profile
            </button>
            <button id="saveBtn" class="btn btn-success hidden">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button id="shareBtn" class="btn btn-secondary">
                <i class="fas fa-share-alt"></i> Share Profile
            </button>
        </div>
    </div>
    <!-- Crop Modal -->
    <div id="cropModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-crop text-red-500 mr-2"></i> Crop Your Profile Picture
            </h3>
            <div class="mb-4">
                <img id="cropImage" class="max-w-full rounded-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelCropBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="applyCropBtn" class="btn btn-primary">
                    <i class="fas fa-check"></i> Apply
                </button>
            </div>
        </div>
    </div>
    <!-- Donation History Modal -->
    <div id="donationHistoryModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-history text-blue-500 mr-2"></i> Donation History
                </h3>
                <button id="closeDonationHistoryBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="donation-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar mr-1"></i> Date</th>
                            <th><i class="fas fa-map-marker-alt mr-1"></i> Place</th>
                            <th><i class="fas fa-tint mr-1"></i> Blood Group</th>
                            <th><i class="fas fa-hashtag mr-1"></i> Donation #</th>
                        </tr>
                    </thead>
                    <tbody id="donationHistoryList">
                        <!-- Donation history will be loaded here -->
                    </tbody>
                </table>
                <div id="noDonationHistory" class="text-center py-12 text-gray-500 hidden">
                    <i class="fas fa-history text-5xl mb-4"></i>
                    <p class="text-lg">No donation history found</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Report Modal -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-flag text-yellow-500 mr-2"></i> Report User
            </h3>
            <form id="reportForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> Reason
                    </label>
                    <select id="reportReason" class="form-input">
                        <option value="">Select a reason</option>
                        <option value="inappropriate">Inappropriate behavior</option>
                        <option value="fake">Fake profile</option>
                        <option value="spam">Spam</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment-alt text-yellow-500 mr-1"></i> Description
                    </label>
                    <textarea id="reportDescription" rows="4" 
                              class="form-input" placeholder="Please provide details about your report..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelReportBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Success Toast -->
    <div id="successToast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="successMessage">Success!</span>
    </div>
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://bbvyjeljeyofswuijlyg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Global variables
        let currentUser = null;
        let donorData = null;
        let isEditMode = false;
        let isOwnProfile = false;
        let userInteraction = null;
        let cropper = null;
        let userRating = null;
        let selectedRating = 0;
        
        // Show success toast
        function showSuccessToast(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.remove('translate-y-20');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 3000);
        }
        
        // Update donation badge based on donation count
        function updateDonationBadge(donationCount) {
            const badge = document.getElementById('donationBadge');
            const badgeIcon = badge.querySelector('i');
            
            // Remove all existing badge classes
            badge.classList.remove('badge-bronze', 'badge-silver', 'badge-gold', 'badge-platinum', 'badge-diamond', 'badge-red-diamond');
            
            // Reset icon
            badgeIcon.className = 'fas text-white text-xl';
            
            if (donationCount >= 1 && donationCount <= 3) {
                badge.classList.add('badge-bronze');
                badgeIcon.classList.add('fa-medal');
            } else if (donationCount >= 4 && donationCount <= 15) {
                badge.classList.add('badge-silver');
                badgeIcon.classList.add('fa-award');
            } else if (donationCount >= 16 && donationCount <= 20) {
                badge.classList.add('badge-gold');
                badgeIcon.classList.add('fa-trophy');
            } else if (donationCount >= 21 && donationCount <= 30) {
                badge.classList.add('badge-platinum');
                badgeIcon.classList.add('fa-gem');
            } else if (donationCount >= 31 && donationCount <= 39) {
                badge.classList.add('badge-diamond');
                badgeIcon.classList.add('fa-gem');
            } else if (donationCount >= 40) {
                badge.classList.add('badge-red-diamond');
                badgeIcon.classList.add('fa-crown');
            }
        }
        
        // Setup star rating
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            const giveRatingBtn = document.getElementById('giveRatingBtn');
            
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    if (userRating) return; // User has already rated
                    
                    const rating = parseInt(star.getAttribute('data-rating'));
                    highlightStars(rating);
                });
                
                star.addEventListener('click', () => {
                    if (userRating) return; // User has already rated
                    
                    const rating = parseInt(star.getAttribute('data-rating'));
                    selectedRating = rating;
                    highlightStars(rating);
                    giveRatingBtn.classList.add('show');
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', () => {
                if (userRating) {
                    highlightStars(userRating);
                } else {
                    highlightStars(selectedRating);
                }
            });
            
            // Give rating button click
            giveRatingBtn.addEventListener('click', async () => {
                if (selectedRating === 0) return;
                
                await submitRating(selectedRating);
                giveRatingBtn.classList.remove('show');
            });
        }
        
        // Highlight stars based on rating
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Submit rating
        async function submitRating(rating) {
            try {
                // Record user rating
                const { error } = await supabase
                    .from('user_ratings')
                    .insert({
                        user_id: currentUser.id,
                        target_donor_id: donorData.id,
                        rating: rating
                    });
                
                if (error) throw error;
                
                userRating = rating;
                selectedRating = 0;
                highlightStars(rating);
                
                // Update average rating display
                await loadAverageRating();
                
                showSuccessToast('Thank you for your rating!');
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Error submitting rating');
            }
        }
        
        // Check if user has already rated
        async function checkUserRating() {
            const { data, error } = await supabase
                .from('user_ratings')
                .select('rating')
                .eq('user_id', currentUser.id)
                .eq('target_donor_id', donorData.id)
                .single();
                
            if (!error && data) {
                userRating = data.rating;
                highlightStars(userRating);
            }
        }
        
        // Load average rating and total star count
        async function loadAverageRating() {
            try {
                // Get all ratings for this donor
                const { data, error } = await supabase
                    .from('user_ratings')
                    .select('rating')
                    .eq('target_donor_id', donorData.id);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    // Calculate average
                    const sum = data.reduce((acc, curr) => acc + curr.rating, 0);
                    const average = sum / data.length;
                    
                    // Update UI
                    document.getElementById('averageRating').textContent = average.toFixed(1);
                    document.getElementById('ratingCount').textContent = `${data.length} ratings`;
                    document.getElementById('totalStarCount').textContent = `Total stars: ${sum}`;
                } else {
                    // No ratings yet
                    document.getElementById('averageRating').textContent = '0.0';
                    document.getElementById('ratingCount').textContent = '0 ratings';
                    document.getElementById('totalStarCount').textContent = 'Total stars: 0`;
                }
            } catch (error) {
                console.error('Error loading average rating:', error);
            }
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Get donor ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const donorId = urlParams.get('id');
            
            console.log('Retrieved donor ID from URL:', donorId); // Debug log
            
            if (!donorId) {
                alert('No donor ID specified. Redirecting to donor list...');
                window.location.href = 'index.html';
                return;
            }
            
            await checkAuth();
            
            if (currentUser) {
                // Check if this is the user's own profile
                isOwnProfile = currentUser.id === donorId;
                console.log('Is own profile:', isOwnProfile); // Debug log
            }
            
            // Load the donor profile
            await loadDonorProfile(donorId);
            
            // Setup star rating
            setupStarRating();
            
            // Check if user has already rated
            await checkUserRating();
            
            // Load average rating
            await loadAverageRating();
            
            // Setup photo upload only if it's the user's own profile
            if (isOwnProfile) {
                setupPhotoUpload();
            }
            
            // Setup donation history
            setupDonationHistory();
            
            // Setup share button
            setupShareButton();
        });
        
        // Authentication check
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error || !user) {
                window.location.href = '/login.html';
                return;
            }
            
            currentUser = user;
        }
        
        // Load donor profile
        async function loadDonorProfile(donorId) {
            try {
                console.log('Loading donor profile for ID:', donorId); // Debug log
                
                // Load donor data
                const { data, error } = await supabase
                    .from('donors')
                    .select('*')
                    .eq('id', donorId)
                    .single();
                    
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                if (!data) {
                    console.error('No donor data found for ID:', donorId);
                    throw new Error('Donor not found');
                }
                
                console.log('Donor data loaded:', data); // Debug log
                
                donorData = data;
                updateUI();
                
                // Hide edit button if it's not the user's own profile
                if (!isOwnProfile) {
                    document.getElementById('editBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading donor data:', error);
                alert('Error loading profile data: ' + error.message);
                window.location.href = 'index.html';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Update UI with donor data
        function updateUI() {
            // Profile info
            document.getElementById('userName').textContent = donorData.name;
            document.getElementById('bloodGroup').innerHTML = `<i class="fas fa-tint mr-1"></i> ${donorData.blood_group}`;
            document.getElementById('userAge').innerHTML = `<i class="fas fa-user mr-1"></i> ${donorData.age} years`;
            
            if (donorData.avatar_url) {
                document.getElementById('profilePhoto').src = donorData.avatar_url;
            }
            
            // Update donation badge
            updateDonationBadge(donorData.times_donated || 0);
            
            // Donation stats
            document.getElementById('totalDonations').textContent = donorData.times_donated || 0;
            
            const lastDonationDate = new Date(donorData.last_donation);
            const daysSinceLastDonation = Math.floor((new Date() - lastDonationDate) / (1000 * 60 * 60 * 24));
            document.getElementById('lastDonation').textContent = `${daysSinceLastDonation} days ago`;
            
            // Calculate progress
            const daysRemaining = Math.max(0, 90 - daysSinceLastDonation);
            const progressPercent = Math.min(100, Math.floor((daysSinceLastDonation / 90) * 100));
            
            updateProgressCircle(progressPercent);
            document.getElementById('nextDonationText').innerHTML = 
                daysRemaining > 0 
                    ? `This donor will be eligible to donate in <span class="font-bold text-red-500">${daysRemaining} days</span>`
                    : 'This donor is eligible to donate now!';
            
            // User info
            document.getElementById('phoneInput').value = donorData.phone || '';
            document.getElementById('cityInput').value = donorData.city || '';
            document.getElementById('districtInput').value = donorData.division || '';
            document.getElementById('userIdInput').value = donorData.custom_id || donorData.id.toString().substring(0, 8);
        }
        
        // Update progress circle
        function updateProgressCircle(percent) {
            const circle = document.getElementById('progressCircle');
            const radius = 86;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = `${percent}%`;
        }
        
        // Setup photo upload
        function setupPhotoUpload() {
            const profilePhoto = document.getElementById('profilePhoto');
            const photoUpload = document.getElementById('photoUpload');
            const uploadOverlay = document.querySelector('.upload-overlay');
            
            // Click on overlay or photo to trigger file input
            uploadOverlay.addEventListener('click', () => {
                photoUpload.click();
            });
            
            profilePhoto.addEventListener('click', () => {
                photoUpload.click();
            });
            
            // Handle file selection
            photoUpload.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        // Show crop modal
                        document.getElementById('cropImage').src = event.target.result;
                        document.getElementById('cropModal').classList.remove('hidden');
                        
                        // Initialize cropper
                        setTimeout(() => {
                            if (cropper) {
                                cropper.destroy();
                            }
                            
                            const image = document.getElementById('cropImage');
                            cropper = new Cropper(image, {
                                aspectRatio: 1,
                                viewMode: 2,
                                autoCropArea: 0.8,
                                responsive: true,
                                checkCrossOrigin: false
                            });
                        }, 100);
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Cancel crop
            document.getElementById('cancelCropBtn').addEventListener('click', () => {
                document.getElementById('cropModal').classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });
            
            // Apply crop
            document.getElementById('applyCropBtn').addEventListener('click', async () => {
                if (cropper) {
                    // Get cropped canvas
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300,
                        minWidth: 256,
                        minHeight: 256,
                        maxWidth: 4096,
                        maxHeight: 4096,
                        fillColor: '#fff',
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    });
                    
                    // Convert to blob
                    canvas.toBlob(async (blob) => {
                        try {
                            // Show loading
                            document.getElementById('loading').style.display = 'flex';
                            
                            // Generate unique filename
                            const fileName = `profile-${currentUser.id}-${Date.now()}.jpg`;
                            
                            // Upload to Supabase Storage
                            const { data, error } = await supabase.storage
                                .from('avatars')
                                .upload(fileName, blob, {
                                    contentType: 'image/jpeg',
                                    upsert: false
                                });
                            
                            if (error) throw error;
                            
                            // Get public URL
                            const { data: publicUrlData } = supabase.storage
                                .from('avatars')
                                .getPublicUrl(fileName);
                            
                            const avatarUrl = publicUrlData.publicUrl;
                            
                            // Update donor record
                            const { error: updateError } = await supabase
                                .from('donors')
                                .update({ avatar_url: avatarUrl })
                                .eq('id', donorData.id);
                            
                            if (updateError) throw updateError;
                            
                            // Update UI
                            document.getElementById('profilePhoto').src = avatarUrl;
                            donorData.avatar_url = avatarUrl;
                            
                            // Close modal and destroy cropper
                            document.getElementById('cropModal').classList.add('hidden');
                            cropper.destroy();
                            cropper = null;
                            
                            showSuccessToast('Profile picture updated successfully!');
                        } catch (error) {
                            console.error('Error uploading profile picture:', error);
                            alert('Error uploading profile picture');
                        } finally {
                            document.getElementById('loading').style.display = 'none';
                        }
                    }, 'image/jpeg', 0.9);
                }
            });
        }
        
        // Setup share button
        function setupShareButton() {
            document.getElementById('shareBtn').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: `${donorData.name} - Blood Donor Profile`,
                        text: `Check out ${donorData.name}'s blood donor profile on Look4Blood`,
                        url: window.location.href
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const dummy = document.createElement('input');
                    document.body.appendChild(dummy);
                    dummy.value = window.location.href;
                    dummy.select();
                    document.execCommand('copy');
                    document.body.removeChild(dummy);
                    showSuccessToast('Profile link copied to clipboard!');
                }
            });
        }
        
        // Setup donation history
        function setupDonationHistory() {
            const donationHistoryBtn = document.getElementById('donationHistoryBtn');
            const donationHistoryModal = document.getElementById('donationHistoryModal');
            const closeDonationHistoryBtn = document.getElementById('closeDonationHistoryBtn');
            
            donationHistoryBtn.addEventListener('click', async () => {
                // Show loading
                document.getElementById('loading').style.display = 'flex';
                
                try {
                    // Fetch donation history
                    const { data, error } = await supabase
                        .from('donation_updates')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('donation_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    // Populate donation history table
                    const donationHistoryList = document.getElementById('donationHistoryList');
                    const noDonationHistory = document.getElementById('noDonationHistory');
                    
                    if (data && data.length > 0) {
                        donationHistoryList.innerHTML = data.map(donation => `
                            <tr>
                                <td>${new Date(donation.donation_date).toLocaleDateString()}</td>
                                <td>${donation.place || 'N/A'}</td>
                                <td><span class="badge badge-blood">${donation.blood_group}</span></td>
                                <td>#${donation.times_donated}</td>
                            </tr>
                        `).join('');
                        donationHistoryList.classList.remove('hidden');
                        noDonationHistory.classList.add('hidden');
                    } else {
                        donationHistoryList.innerHTML = '';
                        donationHistoryList.classList.add('hidden');
                        noDonationHistory.classList.remove('hidden');
                    }
                    
                    // Show modal
                    donationHistoryModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error loading donation history:', error);
                    alert('Error loading donation history');
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            closeDonationHistoryBtn.addEventListener('click', () => {
                donationHistoryModal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            donationHistoryModal.addEventListener('click', (e) => {
                if (e.target === donationHistoryModal) {
                    donationHistoryModal.classList.add('hidden');
                }
            });
        }
        
        // Comment functionality
        document.getElementById('commentBtn').addEventListener('click', () => {
            const section = document.getElementById('commentsSection');
            section.classList.toggle('open');
            
            if (section.classList.contains('open')) {
                loadComments();
            }
        });
        
        async function loadComments() {
            try {
                const { data, error } = await supabase
                    .from('comments')
                    .select(`
                        *,
                        donors(name, avatar_url)
                    `)
                    .eq('target_donor_id', donorData.id)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                const commentsList = document.getElementById('commentsList');
                
                if (data && data.length > 0) {
                    commentsList.innerHTML = data.map(comment => `
                        <div class="flex space-x-3 p-4 bg-gray-50 rounded-lg">
                            <img src="${comment.donors?.avatar_url || 'https://picsum.photos/seed/default/40/40.jpg'}" 
                                 alt="User" class="w-12 h-12 rounded-full object-cover">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${comment.donors?.name || 'Anonymous'}</p>
                                <p class="text-gray-700 mt-1">${comment.content}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${new Date(comment.created_at).toLocaleDateString()}
                                </p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    commentsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-comments text-4xl mb-3"></i>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }
        
        // Add comment
        document.getElementById('addCommentBtn').addEventListener('click', async () => {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const { error } = await supabase
                    .from('comments')
                    .insert({
                        user_id: currentUser.id,
                        target_donor_id: donorData.id,
                        content: content
                    });
                    
                if (error) throw error;
                
                input.value = '';
                loadComments();
                showSuccessToast('Comment added successfully!');
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment');
            }
        });
        
        // Report functionality
        document.getElementById('reportBtn').addEventListener('click', () => {
            document.getElementById('reportModal').classList.remove('hidden');
        });
        
        document.getElementById('cancelReportBtn').addEventListener('click', () => {
            document.getElementById('reportModal').classList.add('hidden');
        });
        
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!reason) {
                alert('Please select a reason');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('reports')
                    .insert({
                        reporter_id: currentUser.id,
                        reported_donor_id: donorData.id,
                        reason: reason,
                        description: description
                    });
                    
                if (error) throw error;
                
                showSuccessToast('Report submitted successfully');
                document.getElementById('reportModal').classList.add('hidden');
                document.getElementById('reportForm').reset();
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Error submitting report');
            }
        });
        
        // Edit/Save functionality
        document.getElementById('editBtn').addEventListener('click', () => {
            isEditMode = true;
            document.getElementById('editBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            
            // Enable editable fields
            document.getElementById('phoneInput').disabled = false;
            document.getElementById('cityInput').disabled = false;
            document.getElementById('districtInput').disabled = false;
            
            // Change background to indicate edit mode
            document.getElementById('phoneInput').classList.remove('bg-gray-50');
            document.getElementById('cityInput').classList.remove('bg-gray-50');
            document.getElementById('districtInput').classList.remove('bg-gray-50');
        });
        
        document.getElementById('saveBtn').addEventListener('click', async () => {
            try {
                const updateData = {
                    phone: document.getElementById('phoneInput').value,
                    city: document.getElementById('cityInput').value,
                    division: document.getElementById('districtInput').value
                };
                
                const { error } = await supabase
                    .from('donors')
                    .update(updateData)
                    .eq('id', donorData.id);
                    
                if (error) throw error;
                
                // Update local data
                donorData = { ...donorData, ...updateData };
                
                // Exit edit mode
                isEditMode = false;
                document.getElementById('editBtn').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                
                // Disable fields
                document.getElementById('phoneInput').disabled = true;
                document.getElementById('cityInput').disabled = true;
                document.getElementById('districtInput').disabled = true;
                
                // Restore background
                document.getElementById('phoneInput').classList.add('bg-gray-50');
                document.getElementById('cityInput').classList.add('bg-gray-50');
                document.getElementById('districtInput').classList.add('bg-gray-50');
                
                showSuccessToast('Profile updated successfully');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>User Profile with Supabase</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet"/>
<!-- Cropper.js CSS -->
<link href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css" rel="stylesheet"/>
<style>
  /* Reset and base styles omitted for brevity, include previous styles here */

  /* Overlay for login/register prompt */
  #authPrompt {
    display: none; /* Hidden by default, shown when not logged in */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    align-items: center; justify-content: center;
    z-index: 10000;
  }
  #authPromptContent {
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
  }
  #authPrompt button {
    margin: 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  #authPrompt button:hover {
    filter: brightness(0.9);
  }
</style>
</head>
<body>

<!-- Auth prompt overlay -->
<div id="authPrompt">
  <div id="authPromptContent">
    <h2>Please Login/Register</h2>
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
</div>

<!-- Main profile container (hidden until logged in) -->
<div class="profile-container" style="display:none;" id="profileContainer">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-image-wrapper">
      <img src="" alt="Profile" class="profile-image" id="profileImage"/>
      <div class="upload-overlay" title="Change Profile Picture" id="uploadBtn">üì∑</div>
    </div>
    <div class="profile-info">
      <h1 class="name-title" id="name"></h1>
      <div class="award-badge" id="bloodType"></div>
    </div>
  </div>

  <!-- Stats & Progress -->
  <div class="stats-cards">
    <div class="card">
      <div class="progress-ring" id="progressRing">
        <canvas id="ringCanvas" width="120" height="120"></canvas>
      </div>
      <div class="donation-info" id="donationStatus"></div>
    </div>
    <div class="card">
      <h2 id="timesDonated"></h2>
      <p>Times Donated</p>
      <small>Last donation: <span id="lastDonation"></span></small>
    </div>
    <div class="card" style="text-align:center;">
      <button id="likeBtn" style="border:none; background:none; font-size:2em; cursor:pointer; transition:transform 0.3s;">üëç</button>
      <h2 id="likesCount">0</h2>
    </div>
    <div class="card" style="text-align:center;">
      <button id="dislikeBtn" style="border:none; background:none; font-size:2em; cursor:pointer; transition:transform 0.3s;">üëé</button>
      <h2 id="dislikesCount">0</h2>
    </div>
  </div>

  <!-- User Info -->
  <div class="user-info">
    <h3>User Info</h3>
    <!-- info rows with editable spans -->
    <div class="info-row">
      <div class="info-label">Name</div>
      <div class="info-value"><span class="view" id="nameField"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">Age</div>
      <div class="info-value"><span class="view" id="age"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">Phone</div>
      <div class="info-value"><span class="view" id="phone"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">State</div>
      <div class="info-value"><span class="view" id="state"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">City</div>
      <div class="info-value"><span class="view" id="city"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">Blood Group</div>
      <div class="info-value"><span class="view" id="blood_group"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">Last Donation</div>
      <div class="info-value"><span class="view" id="last_donation"></span></div>
    </div>
    <div class="info-row">
      <div class="info-label">Times Donated</div>
      <div class="info-value"><span class="view" id="times_donated"></span></div>
    </div>
    <div class="buttons">
      <button class="btn-edit" id="editBtn">Edit</button>
      <button class="btn-save" id="saveBtn" style="display:none;">Save</button>
    </div>
  </div>
</div>

<!-- Modal for cropping image -->
<div id="cropperModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:600px; width:90%; position:relative;">
    <h3>Crop Image</h3>
    <img id="cropperImage" style="max-width:100%; display:block; margin-bottom:10px;"/>
    <div style="text-align:right;">
      <button id="cropBtn" style="margin-right:10px; padding:8px 16px; border:none; background:#27ae60; color:#fff; border-radius:5px;">Crop & Upload</button>
      <button id="cancelCrop" style="padding:8px 16px; border:none; background:#e74c3c; color:#fff; border-radius:5px;">Cancel</button>
    </div>
  </div>
</div>

<!-- Cropper.js and Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>

<script>
  // Initialize Supabase
  const supabaseUrl = 'https://bbvyjeljeyofswuijlyg.supabase.co'; // replace with your URL
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidnlqZWxqZXlvZnN3dWlqbHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTY2MzEsImV4cCI6MjA2NzM3MjYzMX0.m3YNxZK-W8thAsuo8FAda49Bz5zbQHDaTfi-6yY136I'; // replace with your anon key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Elements
  const authPrompt = document.getElementById('authPrompt');
  const profileContainer = document.getElementById('profileContainer');

  // Check auth on load
  checkAuth();

  async function checkAuth() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if (!session) {
      authPrompt.style.display = 'flex';
    } else {
      authPrompt.style.display = 'none';
      profileContainer.style.display = 'block';
      loadProfile(session.user.id);
    }
  }

  // Redirect buttons
  document.getElementById('loginBtn').onclick = () => {
    window.location.href = 'userlogin.html';
  };
  document.getElementById('registerBtn').onclick = () => {
    window.location.href = 'register.html';
  };

  // Load profile data
  async function loadProfile(userId) {
    const { data, error } = await supabase
      .from('donors')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (error || !data) {
      alert('Error fetching profile: ' + (error?.message || 'Profile not found'));
      return;
    }

    // Populate data
    document.getElementById('name').textContent = data.name || 'No Name';
    document.getElementById('age').textContent = data.age || '';
    document.getElementById('phone').textContent = data.phone || '';
    document.getElementById('state').textContent = data.state || '';
    document.getElementById('city').textContent = data.city || '';
    document.getElementById('bloodType').textContent = data.blood_group || '';
    document.getElementById('last_donation').textContent = data.last_donation || '';
    document.getElementById('times_donated').textContent = data.times_donated || '';

    // Profile picture (optional)
    // You can add profile_image_url in your table if desired

    // Save user_id in global scope for updates
    window.currentUserId = data.user_id;
  }

  // Save profile data
async function saveProfile() {
  const updatedData = {
    name: document.getElementById('name').textContent,
    age: document.getElementById('age').textContent,
    phone: document.getElementById('phone').textContent,
    state: document.getElementById('state').textContent,
    city: document.getElementById('city').textContent,
    blood_group: document.getElementById('bloodType').textContent,
    last_donation: document.getElementById('last_donation').textContent,
    times_donated: parseInt(document.getElementById('times_donated').textContent),
  };
  const { data, error } = await supabase
    .from('donors')
    .update(updatedData)
    .eq('user_id', window.currentUserId);
  if (error) alert('Error saving: ' + error.message);
  else {
    alert('Profile updated!');
    loadProfile(window.currentUserId);
  }
}

  // Profile picture upload & crop
  const cropperModal = document.getElementById('cropperModal');
  const cropperImage = document.getElementById('cropperImage');
  let cropperInstance = null;

  document.getElementById('uploadBtn').onclick = () => {
    const input = document.createElement('input');
    input.type='file';
    input.accept='image/*';
    input.onchange= () => {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload= () => {
        cropperImage.src= reader.result;
        cropperModal.style.display='flex';
        if (cropperInstance) cropperInstance.destroy();
        cropperInstance= new Cropper(cropperImage, { aspectRatio:1, viewMode:1 });
      };
      reader.readAsDataURL(file);
    };
    input.click();
  };

  document.getElementById('cropBtn').onclick= async () => {
    if (cropperInstance) {
      cropperInstance.getCroppedCanvas().toBlob( async (blob) => {
        // Upload to Supabase Storage
        const filename= `profile_images/${window.currentUserId}.png`;
        const { data: uploadData, error: uploadError }= await supabase.storage
          .from('profile-images')
          .upload(filename, blob, { upsert: true });
        if (uploadError) {
          alert('Upload error: ' + uploadError.message);
        } else {
          const publicUrl= supabase.storage
            .from('profile-images')
            .getPublicUrl(filename).data.publicUrl;
          // Save URL in donors table
          await supabase.from('donors').update({ profile_image_url: publicUrl }).eq('user_id', window.currentUserId);
          document.getElementById('profileImage').src= publicUrl;
        }
        cropperInstance.destroy();
        cropperInstance= null;
        document.getElementById('cropperModal').style.display='none';
      });
    }
  };
  document.getElementById('cancelCrop').onclick= () => {
    if (cropperInstance) cropperInstance.destroy();
    cropperInstance= null;
    document.getElementById('cropperModal').style.display='none';
  };

  // Animate progress ring
  const ctx = document.getElementById('ringCanvas').getContext('2d');
  function drawRing(percent) {
    ctx.clearRect(0, 0, 120, 120);
    ctx.beginPath();
    ctx.arc(60, 60, 50, 0, 2*Math.PI);
    ctx.strokeStyle='#e0e0e0';
    ctx.lineWidth=10;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(60, 60, 50, -Math.PI/2, -Math.PI/2 + 2*Math.PI*percent);
    ctx.strokeStyle='#3498db';
    ctx.lineWidth=10;
    ctx.lineCap='round';
    ctx.stroke();
  }

  function animateRing(targetPercent) {
    let start= null;
    const duration= 1500;
    function animate(time) {
      if (!start) start= time;
      const progress= Math.min((time - start)/duration,1);
      drawRing(progress*targetPercent);
      if (progress<1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }

  // Likes & Dislikes
  const likeBtn= document.getElementById('likeBtn');
  const dislikeBtn= document.getElementById('dislikeBtn');
  const likesCount= document.getElementById('likesCount');
  const dislikesCount= document.getElementById('dislikesCount');

  likeBtn.onclick= async () => {
    let count= parseInt(likesCount.textContent)||0;
    count++;
    likesCount.textContent= count;
    likeBtn.style.transform='scale(1.2)';
    setTimeout(()=>likeBtn.style.transform='scale(1)', 200);
    await supabase.from('donors').update({ likes: count }).eq('user_id', window.currentUserId);
  };

  dislikeBtn.onclick= async () => {
    let count= parseInt(dislikesCount.textContent)||0;
    count++;
    dislikesCount.textContent= count;
    dislikeBtn.style.transform='scale(1.2)';
    setTimeout(()=>dislikeBtn.style.transform='scale(1)', 200);
    await supabase.from('donors').update({ dislikes: count }).eq('user_id', window.currentUserId);
  };

  // Edit / Save profile info
  const editBtn= document.getElementById('editBtn');
  const saveBtn= document.getElementById('saveBtn');
  const fieldIds= ['name', 'age', 'phone', 'state', 'city', 'blood_group', 'last_donation', 'times_donated'];
  let isEditing= false;

  function toggleEdit(editing) {
    fieldIds.forEach(id => {
      const span= document.getElementById(id);
      if (editing) {
        const input= document.createElement('input');
        input.type='text';
        input.id= id+'Input';
        input.value= span.textContent;
        input.style.width='100%';
        span.replaceWith(input);
      } else {
        const input= document.getElementById(id+'Input');
        if (input) {
          span.textContent= input.value;
          input.replaceWith(span);
        }
      }
    });
    document.getElementById('editBtn').style.display= editing?'none':'inline-block';
    document.getElementById('saveBtn').style.display= editing?'inline-block':'none';
  }

  document.getElementById('editBtn').onclick= ()=> { toggleEdit(true); };
  document.getElementById('saveBtn').onclick= ()=> { saveProfile(); toggleEdit(false); };

</script>
</body>
</html>
